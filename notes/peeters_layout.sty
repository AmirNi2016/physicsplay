%
% Copyright Â© 2012 Peeter Joot.  All Rights Reserved.
% Licenced as described in the file LICENSE under the root directory of this GIT repository.
%
%
%-----------------------------------------------------------------------------------
%
% This latex file is for style related stuff (mostly color related), to be used in
% my notes collections based on the
% classicthesis template.
%
% Some of these are also applicable to articles that use the scrreprt
% document class.
%
% Basic macros (\Br, ...) have been left in peeters_macros (but this imports those as a side effect).
%
%-----------------------------------------------------------------------------------

%\ProvidesPackage{peeters_layout}[Peeter's layout specific commands for both classicthesis and articles]
\RequirePackage{peeters_macros}
\RequirePackage{amsmath}

%-----------------------------------------------------------------------------------
% See marco's answer in:
   %       http://tex.stackexchange.com/questions/53808/miktex-font-ccicons-at-600-not-found
   %
   % to use this package with MikTex on Windows 7.
   %
   \RequirePackage{ccicons}
   % provides: \ccbyncnd

%-----------------------------------------------------------------------------------
% for captionof:

   % also using caption for color captions:
   % http://www.latex-community.org/forum/viewtopic.php?f=45&p=42828
   \PassOptionsToPackage{dvipsnames,svgnames}{xcolor}
   \RequirePackage{caption}
   \captionsetup{labelfont={color=DarkOliveGreen,bf},textfont={color=Maroon}}

%--------------------------------------------------------------------------------------------
% Color equation numbers:

   % http://tex.stackexchange.com/questions/28903/changing-the-apperance-of-equation-numbers-with-amsmath/28907#28907
   % http://tex.stackexchange.com/questions/50521/coloured-equation-number-without-changing-colour-of-reference-using-hyperref
   \makeatletter
   \let\mytagform@=\tagform@
   \def\tagform@#1{\maketag@@@{\color{DarkOliveGreen}(#1)}}
   \makeatother

%------------------------------------------------------------------------------------
% http://tex.stackexchange.com/questions/57253/in-a-multiple-file-latex-document-is-there-a-way-to-tag-each-page-with-the-file
%
% could restrict to drafting mode:
% <didn't end up needing this.>

   %\RequirePackage{fancyhdr}
   %\RequirePackage{currfile}
   %\pagestyle{fancy}
   %\lhead{}
   %\chead{}
   %\rhead{}
   %\lfoot{}
   %\cfoot{\thepage}
   %\rfoot{\currfilepath}
   %\renewcommand\headrulewidth{0pt}
   %\renewcommand\footrulewidth{0pt}

%-----------------------------------------------------------------------------------

\RequirePackage{exercise}

   %-----------------------------------------------------------------------------------
   % remove the centerline that we have in exercise.sty
   % and add some color.  and add chapter numbers.
   %
   %\renewcommand{\ExerciseHeader}{\leftline{\textbf{\large\color{DarkOliveGreen}{\ExerciseName\ \thechapter.\ExerciseHeaderNB} \color{Maroon}{\ExerciseHeaderTitle}\ExerciseHeaderOrigin\medskip}}}
   %\renewcommand{\AnswerHeader}{\medskip\leftline{\textbf{\color{Maroon}{Answer for \ExerciseName}\ \color{DarkOliveGreen}{\thechapter.\ExerciseHeaderNB}}\smallskip}}
   %-----------------------------------------------------------------------------
   % Better: chapter numbers within exersize counters.  Let the chngcntr package do the work (it also works properly across a chapter boundary)
   % http://tex.stackexchange.com/questions/27444/number-exercises-according-to-chapter
   %
   %\RequirePackage{chngcntr}
   %\newcounter{Example}
   %\counterwithin{Example}{chapter}
   %\counterwithin{Exercise}{chapter}
   %\counterwithin{Answer}{chapter}
   %-----------------------------------------------------------------------------
   % use of chngcntr as above worked fine until I started using Examples.  Here's the issue and solution:
   %
   % http://tex.stackexchange.com/questions/56927/help-with-exercise-sty-counter-not-shown-incremented#56933
   \renewcounter{Exercise}[chapter]
   \makeatletter
   \renewcommand{\theExercise}{\if@ExeStared\else\thechapter.\arabic{\@ExerciseCounter}\fi}
   \makeatother
   \newcounter{Example}
   \renewcounter{Example}[chapter]
   %-----------------------------------------------------------------------------
   \renewcommand{\ExerciseHeader}{\leftline{\textbf{\large\color{DarkOliveGreen}{\ExerciseName\ \ExerciseHeaderNB} \color{Maroon}{\ExerciseHeaderTitle}\ExerciseHeaderOrigin\medskip}}}
   \renewcommand{\AnswerHeader}{\medskip\leftline{\textbf{\color{Maroon}{Answer for \ExerciseName}\ \color{DarkOliveGreen}{\ExerciseHeaderNB}}\smallskip}}
   %-----------------------------------------------------------------------------

%-----------------------------------------------------------------------------------
% want indexes, but it's a lot of work to add in the indexing after the fact.  Stub this out as opposed to making a crappy one.
% (that comment applied to phy454.pdf)
%

%   \RequirePackage{makeidx}
%   \makeindex
%\newcommand{\index}[1]{}

%--------------------------------------------------------------------------------------------
% Long equation support:
%

   % http://tex.stackexchange.com/questions/21290/how-to-make-left-right-pairs-of-delimiter-work-over-multiple-lines
   % breqn package supports \left \right over multiple lines.

   % Note: mathpazo option required for flexisym if I want \boldsymbol{\Omega} to work.  otherwise it
   % shows up as a solid black box.
   %
   \PassOptionsToPackage{mathpazo}{flexisym}
   \RequirePackage{flexisym}
   \RequirePackage{breqn}
   % and this one for dmath env equation numbers
   % http://tex.stackexchange.com/questions/57007/colored-equation-numbers-with-breqn-package/57008#57008
   \renewcommand{\eqnumcolor}{\color{DarkOliveGreen}}

%-----------------------------------------------------------------------------------
% 
% Misc. new commands.  could potentially move to peeters_macros 
%

% this doesn't work in an Exercise environment, and the paragraph text ends up displayed later (for example in the summary
% sections.  have removed all references).
% could probably fix this like done in \imageFigure, making the \paragraph{} use ifinner predicate.
% verify output.  have changed \titleformat for paragraph below instead.
%\newcommand{\unnumberedSubsection}[1]{{\color{Maroon}{\paragraph{#1}}}}
\newcommand{\unnumberedSubsection}[1]{\paragraph{#1}}

\newcommand{\question}[0]{unnumberedSubsection{Question:}}
\newcommand{\answer}[0]{unnumberedSubsection{Answer:}}

\newtheorem{mydefinition}[theorem]{\color{DarkOliveGreen}Definition}

\newcommand{\makedefinition}[3]{
\begin{mydefinition}%
\emph{(\color{Maroon}{#1})}%
\label{#2}%
\par%
#3%
\end{mydefinition}%
}

% title, label, text
\newcommand{\makeexample}[3]{%
\begin{Exercise}[%
title={#1},%
label={#2},%
name={Example},%
counter={Example}%
]%
\noindent{\color{Maroon}{\rule{\linewidth}{0.5mm}}}
\par
#3%
\par\noindent
{\color{Maroon}{\rule{\linewidth}{0.5mm}}}
\end{Exercise}%
}
%\addcontentsline{toc}{section}{Example \thechapter.\theExample\ #1}
%\pdfbookmark[1]{Example \thechapter.\theExample\ #1}{ex\thechapter.\theExample}

\newcommand{\makeproblem}[3]{%
\begin{Exercise}[%
title={#1},%
label={#2}%
]%
#3%
\end{Exercise}%
}

\newcommand{\makeoproblem}[4]{%
\begin{Exercise}[%
title={#1},%
label={#2},%
origin={#3}%
]%
#4%
\end{Exercise}%
}

%\addcontentsline{toc}{section}{Example \thechapter.\theExercise\ #1}
%\pdfbookmark[1]{Example \thechapter.\theExercise\ #1}{ex\thechapter.\theExercise}

% {label}{text}
\newcommand{\makeanswer}[2]{%
\begin{Answer}[%
ref={#1}
]%
#2%
\end{Answer}%
}

\newcommand{\makesubproblem}[2]{%
\Question{#1\label{#2}}
}

% paragraph initially didn't appear to work but think that was because I'd messed up the params to 
% \makeanswer.  Regardless, this is nicer coloring than just plain paragraph (which is auto-colored now).
%\paragraph{Solution Part \ref{#2}. #1}
\newcommand{\makesubanswer}[2]{%
\par%
{\color{DarkOliveGreen}{Solution Part \ref{#2}.}}  {\color{Maroon}{\textit{#1}}}%
}

\newcommand{\makeSubAnswer}[2]{%
%Part \ref{#2}.  #1%
\paragraph{Part \ref{#2}.  #1}%
}

%\newcommand{\FIXME}[1]{\unnumberedSubsection{EDITING NOTE}\par#1}
\newcommand{\FIXME}[1]{}
%--------------------------------------------------------------------------------------------


% titlesec package based modifications, based on the titleformat's found in classicthesis.  I've added color:
\newcommand{\myClassicThesisOverrides}[0]{%
   \titleformat{\chapter}[display]
      {\relax}{\mbox{}\oldmarginpar{\vspace*{-3\baselineskip}\color{DarkOliveGreen}\chapterNumber\thechapter}}{0pt}%
      {\color{Maroon}\raggedright\spacedallcaps}[\normalsize\vspace*{.8\baselineskip}\titlerule]
   \titleformat{\section}
      {\relax}{\color{DarkOliveGreen}{\textsc{\MakeTextLowercase{\thesection}}}}{1em}{\color{Maroon}\spacedlowsmallcaps}
   \titleformat{\subsection}
      {\relax}{\color{DarkOliveGreen}{\textsc{\MakeTextLowercase{\thesubsection}}}}{1em}{\color{Maroon}\normalsize\itshape}
   \titleformat{\subsubsection}
      {\relax}{\color{DarkOliveGreen}{\textsc{\MakeTextLowercase{\thesubsubsection}}}}{1em}{\color{Maroon}\normalsize\itshape}        
   \titleformat{\paragraph}[runin]
      {\relax}{\color{DarkOliveGreen}{\textsc{\MakeTextLowercase{\theparagraph}}}}{1em}{\color{Maroon}\normalsize\itshape}        
% not required: only used in Colophon.tex
%     \renewcommand{\finalVersionString}{\emph{Final Version} as of \today\ (\myVersion).}
}

% titlesec modifications like those used in my application of the classicthesis template (above)
% note that I've also got \chapter hacked in peeter_prologue_print2.tex so that it's like \title.
\newcommand{\colorSectionsForArticle}[0]{%
   \titleformat{\section}
      {\relax}{\color{DarkOliveGreen}{\textsc{\thesection}}}{1em}{\color{Maroon}}
   \titleformat{\subsection}
      {\relax}{\color{DarkOliveGreen}{\textsc{\thesubsection}}}{1em}{\color{Maroon}\normalsize\itshape}
   \titleformat{\subsubsection}
      {\relax}{\color{DarkOliveGreen}{\textsc{\thesubsubsection}}}{1em}{\color{Maroon}\normalsize\itshape}
   \titleformat{\paragraph}[runin]
      {\relax}{\color{DarkOliveGreen}{\textsc{\MakeTextLowercase{\theparagraph}}}}{1em}{\color{Maroon}\normalsize\itshape}        
   \titlespacing*{\chapter}{0pt}{1\baselineskip}{1.2\baselineskip}
   \titlespacing*{\section}{0pt}{1.25\baselineskip}{1\baselineskip} 
   \titlespacing*{\subsection}{0pt}{1.25\baselineskip}{1\baselineskip}
   \titlespacing*{\paragraph}{0pt}{1\baselineskip}{1\baselineskip}
}
%--------------------------------------------------------------------------------------------

% http://tex.stackexchange.com/questions/81949/can-individual-items-in-a-list-be-labelled-and-hyperref-linked#comment175241_81949 
%
% link to \phantomsection in mathematica.tex \item lists.
\newcommand{\mathematicaRef}[2]{
\hyperref[path:#1:#2]{#2}
}

%--------------------------------------------------------------------------------------------

% this replaces use of \underbrace{math}_{label}, but requires for each use in an equation environment
% an extra numeric parameter for the l1, l2, l3, m1, m2, m3 ... node and label markers
% [which I'm sure could be automated].
% 
\usepackage{tikz}

\newcounter{mathLableNode}

% formula, text, node#
\newcommand{\myMathWithDescription}[3]{%
\tikz[baseline]{%
    \node[draw=red,rounded corners,anchor=base] (m#3)%
    {$\displaystyle#1$};%
    \node[above of=m#3] (l#3) {#2};%
    \draw[-,red] (l#3) -- (m#3);%
}%
}

\newcommand{\myMathLabelBox}[2]{%
   \stepcounter{mathLableNode}%
   \mathWithDescription{#1}{#2}{\themathLableNode}%
}

% allowing for label placement:
%
% http://www.texample.net/tikz/examples/beamer-arrows/
%
% http://tex.stackexchange.com/questions/86188/labelling-with-arrows-in-an-automated-way/86203#86203

\newif\ifclipme\clipmetrue
\tikzset{labelstyle/.style={LabelStyle/.append style={#1}},linestyle/.style={LineStyle/.append style={#1}}}
\tikzset{LabelStyle/.initial={},LineStyle/.initial={}}

\newcommand{\mathWithDescription}[4][]{{%
    \tikzset{#1}%
    \tikz[baseline]{
        \node[draw=red,rounded corners,anchor=base] (m#4) {$\displaystyle#2$};
        \ifclipme\begin{pgfinterruptboundingbox}\fi
            \node[above of=m#4,font=\strut, LabelStyle] (l#4) {#3};
            \draw[-,red, LineStyle] (l#4) to (m#4);
        \ifclipme\end{pgfinterruptboundingbox}\fi
    }%
}}

\newcommand{\mathWithDescriptionStarred}[3][]{{%
    \clipmefalse%
    \mathWithDescription[#1]{#2}{#3}{\themathLableNode}%
}}

\newcommand{\mathLabelBox}[3][]{%
   \stepcounter{mathLableNode}%
   \mathWithDescription[#1]{#2}{#3}{\themathLableNode}%
   \vphantom{\mathWithDescriptionStarred[#1]{#2}{#3}{\themathLableNode}}%
}

% doesn't work: I think it gets expanded too early:
%\newcommand{\labelBoxPlacementBelow}[0]{labelstyle={below of=m\themathLableNode,below of=m\themathLableNode}}
