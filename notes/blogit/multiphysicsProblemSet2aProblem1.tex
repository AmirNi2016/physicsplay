%
% Copyright © 2014 Peeter Joot.  All Rights Reserved.
% Licenced as described in the file LICENSE under the root directory of this GIT repository.
%
\makeproblem{Conjugate gradient and Gershgorin circles}{multiphysics:problemSet2a:1}{ 
\makesubproblem{}{multiphysics:problemSet2a:1a}

Consider an arbitrary circuit made by positive resistors and independent DC current sources. Prove, mathematically, that its nodal matrix is always symmetric and positive semi-definite.

\makesubproblem{}{multiphysics:problemSet2a:1b}

Consider an electrical network made by:
\begin{itemize}
\item \( N \times N \) square grid of resistors of value \( R \), where \( N \) is the number of resistors per edge. The grid nodes are numbered from \( 1 \) to \( (N +1)^2 \) .  Node 1 is a corner node
\item resistor \( R_g \) between each node of the grid and the reference node.
\item a non-ideal voltage source connected between node 1 and ground.  The voltage source has value \( V_s \) and internal (series) resistance \( R_s \)
\item three current sources between three randomly-selected nodes of the grid and ground. The source current must flow from the grid to the reference node as shown in \cref{fig:problemSet2a:problemSet2aFig1} (and not vice versa!)  Choose the current source values randomly between 10 mA and 100 mA.

\imageFigure{../../figures/ece1254/problemSet2aFig1}{Subcircuit}{fig:problemSet2a:problemSet2aFig1}{0.2}
\end{itemize}
Write a MATLAB routine that generates a SPICE compatible netlist for this system (you can reuse the code you developed for the first problem set). Generate the modified nodal analysis equations

\begin{equation}\label{eqn:multiphysicsProblemSet2a:20}
\BG \Bx = \Bb 
\end{equation}

for a grid with \( N = 40, R = 0.1 \Omega, R_g = 1M \Omega, V_s = 2V, R_s = 0.1 \Omega\).
Then, write in MATLAB your own routine for the conjugate gradient
method. Give to the user the possibility of specifying a preconditioning
matrix P. The routine shall stop iterations when the residual norm
satisfies

\begin{equation}\label{eqn:multiphysicsProblemSet2a:40}
\frac{\Norm{ \BG \Bx - \Bb }_2}{
\Norm{\Bb}_2} < \epsilon
\end{equation}

where \( \epsilon \) is a threshold specified by the user. Use the conjugate gradient method to solve modified nodal analysis \cref{eqn:multiphysicsProblemSet2a:20} of the grid.

Does the conjugate gradient method converge?

\makesubproblem{}{multiphysics:problemSet2a:1c}
Discuss if the conjugate gradient method can be applied to the modified nodal analysis equations of the grid. Support your answer with some numerical results.

\makesubproblem{}{multiphysics:problemSet2a:1d}

Suggest a transformation of the grid that will lead to a circuit equivalent to the original one, but for which conjugate gradient can be used. We call this new circuit ``2D grid''. You will have to use it for all the questions that follow.

\makesubproblem{}{multiphysics:problemSet2a:1e}

Solve the ``2D grid'' circuit using three methods:
\begin{itemize}
\item your own LU decomposition
\item the conjugate gradient method with \( \epsilon = 10^{-3} \)
\item the conjugate gradient method with \( \epsilon = 10^{-3} \) and a tri-diagonal preconditioner \( \BP \)
\end{itemize}
for increasing N. Use \( R = 0.1 \Omega \). Plot the CPU time taken by the three
methods vs N, and the number of iterations taken by the two iterative
methods. Explore a range of N compatible with your PC speed and
memory, but make sure to reach fairly large values of N.

\makesubproblem{}{multiphysics:problemSet2a:1f}
Does preconditioning reduce the number of iterations required by conjugate gradient? Does preconditioning reduce CPU time?
\makesubproblem{}{multiphysics:problemSet2a:1g}
Try to make your code for the conjugate gradient method as efficient as possible. Show the improvements that you have obtained.
\makesubproblem{}{multiphysics:problemSet2a:1h}
Generate nodal analysis \cref{eqn:multiphysicsProblemSet2a:20} for ``2D grid'' with
\( N = 20\). Plot the eigenvalues of \( \BG \) and the Gershgorin circles in three
cases: \( R = 0.1 \Omega, R = 1 \Omega, R = 10 \Omega \). Verify Gershgoring Circle theorem
in the three cases.
\makesubproblem{}{multiphysics:problemSet2a:1i}
 Repeat the previous point for the preconditioned nodal matrix, and compare the circles obtained in the two cases.
\makesubproblem{}{multiphysics:problemSet2a:1j}

Let \( N = 20\), and solve ``2D grid'' with conjugate gradient with
and without preconditioning (use the tri-diagonal preconditioner). Plot
the normalized norm of the residual

\begin{equation}\label{eqn:multiphysicsProblemSet2a:60}
\frac{\Norm{ \BG \Bx - \Bb }_2}{
\Norm{\Bb}_2} 
\end{equation}
versus the iteration counter for three cases: \( R = 0.1\Omega, R = 1\Omega, R =
10\Omega\). Discuss your findings in the light of Gershgorin circles.
} % makeproblem

\makeanswer{multiphysics:problemSet2a:1}{ 
\makeSubAnswer{}{multiphysics:problemSet2a:1a}

\paragraph{Symmetry}

A circuit with only resistors and constant current sources has the MNA form

\begin{equation}\label{eqn:multiphysicsProblemSet2a:80}
\BG \BV = \BI_S.
\end{equation}

The current sources, appearing only in the vector \( \BI_S \), do not effect the symmetry of the \textAndIndex{nodal matrix} \( \BG \).  To show that \( \BG \)  is symmetric, recall that 
%for resistor node specification corresponding to \cref{fig:lecture2:lecture2Fig2} 
this was the sum of stamp matrices of the form
%\imageFigure{../../figures/ece1254/lecture2Fig2}{Resistor node specification}{fig:lecture2:lecture2Fig2}{0.3}

\begin{equation}\label{eqn:multiphysicsProblemSet2a:100}
\kbordermatrix{
    & n_1      & n_2 \\
n_1 & \inv{R}  & -\inv{R} \\
n_2 & -\inv{R} & \inv{R}
}.
\end{equation}

To apply this to an actual system, more precision is required, since subsets of the stamps may not apply to \( \BG \) for resistors connected to the reference node.  Suppose that all \( N \) resistors can be enumerated, each connecting all pairs of nodes \( i, j \), where \( i < j \) with a resistance \( R_{ij} \).  The \( r,s\) element of nodal matrix is then the sum over all the stamps, as follows

\begin{dmath}\label{eqn:multiphysicsProblemSet2a:120}
\lr{\BG}_{r,s} 
= 
\sum_{0 < i < j \le N} \inv{R_{ij}} \lr{ 
    \delta_{ri} \delta_{si}
   +\delta_{rj} \delta_{sj}
   -\delta_{ri} \delta_{sj}
   -\delta_{rj} \delta_{si}
} 
+
\sum_{i = 0, 0 < j \le N} \inv{R_{0j}} 
   \delta_{rj} \delta_{sj}
= \sum_{0 < i < j \le N} \inv{R_{ij}} \lr{ 
   \delta_{ri} \lr{ \delta_{si} - \delta_{sj} }
   +\delta_{rj} \lr{ \delta_{sj} - \delta_{si} }
}
+
\sum_{i = 0, 0 < j \le N} \inv{R_{0j}} 
   \delta_{rj} \delta_{sj}
= \sum_{0 < i < j \le N} \inv{R_{ij}} 
   \lr{ \delta_{ri} - \delta_{rj}} \lr{ \delta_{si} - \delta_{sj} }
+
\sum_{i = 0, 0 < j \le N} \inv{R_{0j}} 
   \delta_{rj} \delta_{sj}.
\end{dmath}

Here the sum is over all the sets of nodes \( i, j \), with an allowance for multiplicities in \( R_{ij} \) between any pair of nodes \( i, j \) (i.e. a parallel resistors between any pair of nodes).

Transposition requires swapping the indexes

\begin{equation}\label{eqn:multiphysicsProblemSet2a:140}
\lr{\BG^\T}_{r,s} 
= \sum_{0 < i < j \le N} \inv{R_{ij}} 
   \lr{ \delta_{si} - \delta_{sj}} \lr{ \delta_{ri} - \delta_{rj} }
+
\sum_{i = 0, 0 < j \le N} \inv{R_{0j}} 
   \delta_{sj} \delta_{rj},
\end{equation}

which is clearly equivalent to \cref{eqn:multiphysicsProblemSet2a:120}, proving that \( \BG \) is symmetric.

\paragraph{Positive semi-definite}
%One way to prove that the nodal matrix is positive semi-definite, would be to show that all the eigenvalues \( \lambda_i \ge 0 \).  
%Although the eigenvalues are all real (symmetric matrix), non-negative eigenvalues cannot be ruled out without some thought.  With real eigenvalues Gershgorin's theorem takes on a simple form, but using that to demonstrate the lower bound it provides is non-negative turns out to be non-trivial (and perhaps not possible).
%
%It turns out to be more profitable to ignore the nature of the eigenvalues and 
The positive semi-definite nature of the nodal matrix can be demonstrated directly from the defining property

\begin{equation}\label{eqn:multiphysicsProblemSet2a:260}
\Bx^\T \BG \Bx \ge 0, \quad \forall \Bx.
\end{equation}

The delta filtering and the nice factorization of the products in the \( \BG \) summation facilitate this

%It's possible that Gershgorin's could be used to provetheorem to prove that the eigenvalues are all greater than or equal to zero.
%%%
%%%For row \( r \) of this matrix, that theorem states
%%%
%%%\begin{equation}\label{eqn:multiphysicsProblemSet2a:160}
%%%\Abs{\lambda - G_{rr} }
%%%\le \sum_{s \ne r} \Abs{ G_{rs} }.
%%%\end{equation}
%%%
%%%Because the eigenvalues are real, this can be written as
%%%
%%%\begin{equation}\label{eqn:multiphysicsProblemSet2a:180}
%%%G_{rr} - \sum_{s \ne r} \Abs{ G_{rs} } \le \lambda \le G_{rr} + \sum_{s \ne r} \Abs{ G_{rs} },
%%%\end{equation}
%%%
%%%so if we want to show that \( \lambda \ge 0 \), this is equivalent to showing
%%%
%%%\begin{equation}\label{eqn:multiphysicsProblemSet2a:200}
%%%G_{rr} \ge \sum_{s \ne r} \Abs{ G_{rs} },
%%%\end{equation}
%%%
%%%or
%%%\begin{equation}\label{eqn:multiphysicsProblemSet2a:220}
%%%\sum_{0 < i < j \le N} \inv{R_{ij}} 
%%%\biglr{
%%%   \lr{ \delta_{ri} - \delta_{rj}}^2
%%%   -
%%%   \sum_{r \ne s} \Abs{\lr{ \delta_{ri} - \delta_{rj}} \lr{ \delta_{si} - \delta_{sj} } }
%%%   } \ge 0.
%%%\end{equation}
%%%
%%%This will clearly be the case if the inequality holds for each \( i, j \), or
%%%
%%%\begin{equation}\label{eqn:multiphysicsProblemSet2a:240}
%%%   \lr{ \delta_{ri} - \delta_{rj}}^2
%%%   \ge
%%%   \sum_{r \ne s} \Abs{\lr{ \delta_{ri} - \delta_{rj}} \lr{ \delta_{si} - \delta_{sj} }} .
%%%\end{equation}

\begin{dmath}\label{eqn:multiphysicsProblemSet2a:280}
\Bx^\T \BG \Bx
= 
\Bx^\T \sum_s \sum_{0 < i < j \le N} \inv{R_{ij}} 
   \lr{ \delta_{ri} - \delta_{rj}} \lr{ \delta_{si} - \delta_{sj} } x_s
+
\Bx^\T \sum_s \sum_{i = 0, 0 < j \le N} \inv{R_{0j}} 
   \delta_{rj} \delta_{sj} x_s
=
\sum_r x_r \sum_{0 < i < j \le N} \inv{R_{ij}} 
   \lr{ \delta_{ri} - \delta_{rj}} \lr{ x_i - x_j }
+
\sum_r x_r \sum_{i = 0, 0 < j \le N} \inv{R_{0j}} 
   \delta_{rj} x_j
=
\sum_{0 < i < j \le N} \inv{R_{ij}} 
   \lr{ x_i - x_j }^2
+
\sum_{i = 0, 0 < j \le N} \inv{R_{0j}} 
   x_j^2
\ge 0.
\end{dmath}

With all the sums involving only resistors (positive) and squares of real numbers (voltages), the nodal matrix has been shown to be semi-positive definite as desired.

%FIXME: remove this on integration into the notes compilation.
\input{../ece1254/conjugateGradientAlgorithm.tex}

\makeSubAnswer{}{multiphysics:problemSet2a:1b}

\paragraph{Generation and solution of the netlist equations}

Code for the netlist generation, the nodal equation generation were implemented respectively in

\begin{itemize}
\item 
\href{https://raw.github.com/peeterjoot/matlab/master/ece1254/ps2a/generateResistorGridNetlist.m}{generateResistorGridNetlist.m}
\item 
\href{https://raw.github.com/peeterjoot/matlab/master/ece1254/ps2a/NodalAnalysis.m}{NodalAnalysis.m}
\end{itemize}

Calls to the functions listed above can be found in driver script \href{https://raw.github.com/peeterjoot/matlab/master/ece1254/ps2a/usenetlistProblemB.m}{usenetlistProblemB.m}

The CG iteration for this matrix (at least for my initial guess) did not converge.

\makeSubAnswer{}{multiphysics:problemSet2a:1c}

Not only did the CG for the circuit above not converge, it diverged.  For example using \href{https://raw.github.com/peeterjoot/matlab/master/ece1254/ps2a/conjugateGradientQuarteroniPrecond.m}{conjugateGradientQuarteroniPrecond.m} the relative error increased with the iteration count as follows

\captionedTable{caption}{tab:multiphysicsProblemSet2a:n}{
\begin{tabular}{|l|l|}
\hline
Iteration & Relative error \\ \hline
0 & \( 5.8 \times 10^2 \) \\ \hline
200 & \( 1.8 \times 10^6 \) \\ \hline
400 & \( 9.3 \times 10^6 \) \\ \hline
600 & \( 2.3 \times 10^7 \) \\ \hline
800 & \( 4.5 \times 10^7 \) \\ \hline
1000 & \( 7.4 \times 10^7 \) \\ \hline
1200 & \( 1.1 \times 10^8 \) \\ \hline
1400 & \( 1.5 \times 10^8 \) \\ \hline
1600 & \( 2.1 \times 10^8 \) \\ \hline
\end{tabular}
}

This lack of convergence is not suprising since the circuit has voltage sources, which results in a non-symmetric nodal matrix.

\makeSubAnswer{}{multiphysics:problemSet2a:1d}

TODO.
\makeSubAnswer{}{multiphysics:problemSet2a:1e}

TODO.
\makeSubAnswer{}{multiphysics:problemSet2a:1f}

TODO.
\makeSubAnswer{}{multiphysics:problemSet2a:1g}

TODO.
\makeSubAnswer{}{multiphysics:problemSet2a:1h}

TODO.
\makeSubAnswer{}{multiphysics:problemSet2a:1i}

TODO.
\makeSubAnswer{}{multiphysics:problemSet2a:1j}

TODO.
}

