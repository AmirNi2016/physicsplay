#! /usr/bin/perl

# TODO for wp-mathjax:
#
# - find the inline equations and change them to: \( \)
#  ... should just use \( \) directly in new writing.
#
# - title and prologue
#
# - \cref{FigN} -> fig. N

use strict ;
use warnings ;
use Getopt::Long;

my $filebase ;
my $showUsage = 0 ;

my $urlMessage ;
$urlMessage = "Click here for a PDF of this post with nicer formatting" ;

GetOptions( 
   'file=s'       => \$filebase,
   'help!'        => \$showUsage,
) ;

if ( $showUsage or !defined $filebase )
{
   die "usage: ~/bin/tex2mathjax -f filenameWithoutTexSuffix [-help]" ;
}

my $rLines = slurpLatex( $filebase ) ;

print "[mathjax]\n" ;

foreach (@$rLines)
{
   chomp ;

   s,\\renewcommand{\\basename}{(.*?)},\\blogpage{http://peeterjoot.com/archives/math2014/$1.pdf}, ;
   s,\\blogpage{(.*)},<a href="$1">[$urlMessage]</a>, ;

   s/^ *%.*// ;
   s/^ *\\input.*// ;
   s/^ *\\renewcommand.*// ;
   s/^ *\\newcommand.*// ;
   s/^ *\\usepackage.*// ;
   s/^ *\\beginArtNoToc.*// ;
   s/^ *\\EndArticle.*// ;
   s/^ *\\EndNoBibArticle.*// ;
   s/^ *\\generatetitle{(.*)}/$1/ ;
   s/^ *\\label{chap:.*// ;

   s,{ *\\em\s+(.*?)},<em>$1</em>,g;

   s/\bcref{/ref{/g ;
   s/\beqnref/ref{/g ;
   s/\bEqnref/ref{/g ;

   s,{dmath},{equation}, ;
   s,\\section{(.*)},<h2>$1</h2>,;
   s,\\subsection{(.*)},<h3>$1</h3>,;
   s,\\paragraph{(.*)},<h3>$1</h3>,;

   s,\\begin{itemize},<ul>, ;
   s,\\end{itemize},</ul>, ;
   s,\\item,<li>, ;

   print "$_\n" ;
}

exit 0 ;

sub slurpLatex
{
   my $failedOpen = 0 ;
   my @lines = () ;

   open my $fh, "<$filebase.tex" or $failedOpen = 1 ;
   if ( $failedOpen )
   {
      open $fh, "<$filebase.ltx" or die "could not open '$filebase.tex' nor '$filebase.ltx'\n" ;
   }

   while (<$fh>)
   {
      push( @lines, $_ ) ;
   }
   close $fh ;

   return \@lines ;
}
