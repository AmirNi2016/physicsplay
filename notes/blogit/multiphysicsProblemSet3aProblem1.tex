%
% Copyright © 2014 Peeter Joot.  All Rights Reserved.
% Licenced as described in the file LICENSE under the root directory of this GIT repository.
%
\makeproblem{Modeling inductors and capacitors and time dependence}{multiphysics:problemSet3a:1}{ 

In this problem you will first extend the circuit simulator that you developed
in the previous problem sets to include capacitors and inductors. Then, you
will use it to simulate a clock-distribution network.

\makesubproblem{}{multiphysics:problemSet3a:1a}

Modify the circuit simulator you developed for the previous
assignments to handle capacitors and inductors. The program should
read a file with the list of: resistors, currents sources, voltage sources,
capacitors, and inductors. The syntax for specifying a capacitor is:

\begin{center}
\textbf{Clabel node1 node2 val}
\end{center} 

where label is an arbitrary label, node1 and node2 are integer circuit
node numbers, and val is the capacitance (a floating point number).
The syntax for specifying an inductor is:

\begin{center}
\textbf{Llabel node1 node2 val}
\end{center} 

where label is an arbitrary label, node1 and node2 are integer circuit
node numbers, and val is the inductance (a floating point number).
Explain how you handle inductors, and which stamp can be proposed to
include them into the modified nodal analysis equations written in the
form

\begin{equation}\label{eqn:multiphysicsProblemSet3a:10}
\BG \Bx(t) + \BC \dot{\Bx}(t) = \BB \Bu(t)
\end{equation}

where the column vector \( \Bu(t) \) contains all sources.

\makesubproblem{}{multiphysics:problemSet3a:1b}

As test system, we consider the network in \cref{fig:problemSet3a:problemSet3aFig1} which distributes the clock signal to 8 blocks of an integrated circuit. The network is in the form of a binary tree with four levels. Each segment is
a transmission line with characteristics (length, per-unit-length parameters) given in \cref{tab:multiphysicsProblemSet3a:20}. Divide each transmission line into segments
of length \( \Delta z = 0.05 \text{mm} \), and model each segment with an RLC circuit
as the one shown in the figure. Model the clock source with a periodic
voltage source with the following characteristics: amplitude 1 V, rise/fall
time 100 ps, period 2 ns, duty cycle 50\%, initial delay 100 ps. The clock

\imageFigure{../../figures/ece1254/problemSet3aFig1}{Network for the distribution of the clock to 8 IC blocks.}{fig:problemSet3a:problemSet3aFig1}{0.3}

\captionedTable{Characteristics of the clock tree network. Note that the resistance, inductance and capacitance values are per-unit-length (p.u.l.)}{tab:multiphysicsProblemSet3a:20}{
\begin{tabular}{|l||l|l|l|l|l|}
\hline
Level  & Length      & Resistance p.u.l    & Inductance p.u.l. & Capacitance p.u.l. \\ 
       & \( [mm] \)  & \( R [\Omega/cm] \) & \( L [nH/cm] \)   & \( C [pF/cm] \) \\ \hline \hline
1      & 6           & 25                  & 5.00              & 2.00            \\ \hline
2      & 4           & 35.7                & 7.14              & 1.40            \\ \hline
3      & 3           & 51.0                & 10.2              & 0.98            \\ \hline
4      & 2           & 51.0                & 10.2              & 0.98            \\ \hline
\end{tabular}
}

\imageFigure{../../figures/ece1254/problemSet3aFig2}{}{fig:problemSet3a:problemSet3aFig2}{0.3}

Model each chip block with a 5 k \( \Omega \) resistor in parallel with a 5 f F capacitor. Write a matlab function that generates a spice-compatible netlist
of the clock distribution network. Report in a table the values of the
resistors, inductors and capacitors that you used in each section.

\makesubproblem{}{multiphysics:problemSet3a:1c}

Simulate the circuit with backward Euler (BE). Use a constant
time-step. Plot the voltage generated by the clock source and the voltage
received by one of the blocks for \( t \in [0,5] \) ns. Suggestion: since the clock
starts a few timesteps after \( t = 0 \), you can assume zero initial conditions
for your simulation.

\makesubproblem{}{multiphysics:problemSet3a:1d}

Explain how did you choose the timestep to be used in the simulation.

\makesubproblem{}{multiphysics:problemSet3a:1e}

Implement and compare two methods for solving differential equations: backward Euler (BE), and trapezoidal rule (TR). Simulate the
circuit with the two methods for different timestep values, ranging from
a coarse timestep to a fine time step. Report in a table the error and
the CPU time for each method. Since we don't have an exact solution
for this system, use as reference solution the output voltage computed
with TR with a very fine time step. In the table, report as error the
maximum absolute error between the computed output voltage and the
reference one.

\makesubproblem{}{multiphysics:problemSet3a:1f}

Plot the error versus the time step on a log-log scale for the two
methods, and comment the obtained results.
} % makeproblem

\makeanswer{multiphysics:problemSet3a:1}{ 
\makeSubAnswer{}{multiphysics:problemSet3a:1a}

To understand how to handle inductors \index{MNA!inductor} in the MNA equations, consider a few representitive examples

\makeexample{Simple RLC circuit}{example:multiphysicsProblemSet3a:30}{
First consider an RLC circuit with a current source as sketched in \cref{fig:problemSet3a:problemSet3aFig3}.

\imageFigure{../../figures/ece1254/problemSet3aFig3}{RLC circuit with current source}{fig:problemSet3a:problemSet3aFig3}{0.3}

With \( Z = 1/R \), the KCLs plus the inductor voltage relation, are
\begin{enumerate}
\item \( -i_s + Z V_1 + C \frac{d(V_1 - V_2)}{dt} = 0 \)
\item \( C \frac{d(V_2 - V_1)}{dt} + i_L = 0 \)
\item \( -(V_2 - 0) + L \frac{di_L}{dt} = 0 \)
\end{enumerate}

This can be put into matrix form as

\begin{equation}\label{eqn:multiphysicsProblemSet3a:30}
\begin{bmatrix}
Z & 0 & 0 \\
0 & 0 & 1 \\
0 & -1 & 0 \\
\end{bmatrix}
\begin{bmatrix}
V_1 \\
V_2 \\
i_L
\end{bmatrix}
+
\begin{bmatrix}
C & -C & 0 \\
-C & C & 0 \\
0 & 0 & L \\
\end{bmatrix}
%\frac{d}{dt}
{\begin{bmatrix}
V_1 \\
V_2 \\
i_L
\end{bmatrix}}'
=
\begin{bmatrix}
i_s \\
0 \\
0
\end{bmatrix}
\end{equation}
}

\makeexample{RLC circuit with voltage source}{example:multiphysicsProblemSet3a:50}{
Now consider the more complex circuit of \cref{fig:problemSet3a:problemSet3aFig4}, with an inductor between two not ground nodes, as well as a voltage source, which will also require the MNA matrix to be augmented.  The equations, starting with the KCLs by node number, are

\begin{enumerate}
\item \( -i_{s_1} + Z (V_1 - V_2) = 0 \)
\item \( Z (V_2 - V_1) + C_1 \frac{d(V_2 - 0)}{dt} + C_2 \frac{d(V_2 - V_3)}{dt} = 0 \)
\item \( C_2 \frac{d(V_3 - V_2)}{dt} + i_{L_{3,4}} - i_{L_{0,3}} = 0 \)
\item \( -i_{L_{3,4}} - i_{s_2} = 0 \)
\item \( V_1 = V_{s_1} \)
\item \( -(V_3 - V_4) + L_2 \frac{d}{dt} i_{L_{3,4}} = 0 \)
\item \( -(0 - V_3) + L_1 \frac{d}{dt} i_{L_{0,3}} = 0 \)
\end{enumerate}

\imageFigure{../../figures/ece1254/problemSet3aFig4}{More complex RLC circuit}{fig:problemSet3a:problemSet3aFig4}{0.3}

In matrix form, this is
\begin{equation}\label{eqn:multiphysicsProblemSet3a:50}
\begin{bmatrix}
Z & -Z & 0 & 0 & -1 & 0 & 0 \\
-Z & Z & 0 & 0 & 0 & 0 & 0 \\
0 & 0 & 0 & 0 & 0 & \mytikzmark{left}{1}1 & -1 \\
0 & 0 & 0 & 0 & 0 & -1\mytikzmark{right}{1} & 0 \\
1 & 0 & 0 & 0 & 0 & 0 & 0 \\
0 & 0 & \mytikzmark{left}{2}-1 & 1\mytikzmark{right}{2} & 0 & 0 & 0 \\
0 & 0 & 1 & 0 & 0 & 0 & 0 \\
\end{bmatrix}
\begin{bmatrix}
V_1 \\
V_2 \\
V_3 \\
V_4 \\
i_{s_1} \\
i_{L_{3,4}} \\
i_{L_{0,3}} \\
\end{bmatrix}
+
\begin{bmatrix}
0 & 0 & 0 & 0 & 0 & 0 & 0 \\
0 & C_1 + C_2 & -C_2 & 0 & 0 & 0 & 0 \\
0 & -C_2 & C_2 & 0 & 0 & 0 & 0 \\
0 & 0 & 0 & 0 & 0 & 0 & 0 \\
0 & 0 & 0 & 0 & 0 & 0 & 0 \\
0 & 0 & 0 & 0 & 0 & \mytikzmark{left}{3}L_2\mytikzmark{right}{3} & 0 \\
0 & 0 & 0 & 0 & 0 & 0 & L_1 \\
\end{bmatrix}
{\begin{bmatrix}
V_1 \\
V_2 \\
V_3 \\
V_4 \\
i_{s_1} \\
i_{L_{3,4}} \\
i_{L_{0,3}} \\
\end{bmatrix}}'
=
\begin{bmatrix}
0 \\
0 \\
0 \\
i_{s_2} \\
V_{s_1} \\
0 \\
0 \\
\end{bmatrix}
\end{equation}

\DrawMyBox[thick, Maroon, rounded corners]{1}
\DrawMyBox[thick, Maroon, rounded corners]{2}
\DrawMyBox[thick, Maroon, rounded corners]{3}
}

\makeexample{Final example}{example:multiphysicsProblemSet3a:n}{
Finally consider a simple example with a single inductor in an interior node as sketched in \cref{fig:ps3aExample3:ps3aExample3Fig1}.
For this example a labelling convention compatible with the implementation to be will be chosen.  This is important to ensure the signs are correct.

\imageFigure{../../figures/ece1254/ps3aExample3Fig1}{A final RLC example circuit}{fig:ps3aExample3:ps3aExample3Fig1}{0.3}

The equations are

\begin{enumerate}
\item \( -i_s + Z (V_1 - 0) -i_{L_{2,1}} = 0 \)
\item \( i_{L_{2,1}} + C \frac{d(V_2 - 0)}{dt} = 0 \)
\item \( -(V_2 - V_1) + L \frac{d}{dt} i_{L_{2,1}} = 0 \),
\end{enumerate}

which have the matrix form

\begin{equation}\label{eqn:multiphysicsL17:n}
\begin{bmatrix}
Z & 0 & \mytikzmark{left}{1}{-1} \\
0 & 0 & 1 \mytikzmark{right}{1} \\
\mytikzmark{left}{2} 1 
& -1 \mytikzmark{right}{2} & 0 \\
\end{bmatrix}
\begin{bmatrix}
V_1 \\
V_2 \\
i_{L_{2,1}} 
\end{bmatrix}
+
\begin{bmatrix}
0 & 0 & 0 \\
0 & C & 0 \\
0 & 0 & \mytikzmark{left}{3}L\mytikzmark{right}{3} \\
\end{bmatrix}
{
\begin{bmatrix}
V_1 \\
V_2 \\
i_{L_{2,1}} 
\end{bmatrix}
}'
=
\begin{bmatrix}
i_s \\
0 \\
0
\end{bmatrix}
\end{equation}

\DrawMyBox[thick, Maroon, rounded corners]{1}
\DrawMyBox[thick, Maroon, rounded corners]{2}
\DrawMyBox[thick, Maroon, rounded corners]{3}
}

From the above examples, the inductor stamp structure can be observed.  For an inductance \( L \) between nodes \( n_i, n_j \) and a current \( i_{L_{n_i, n_j}} \) directed from \( n_i \) to \( n_j \) that \( \BG \) portion of that stamp is

\begin{equation}\label{eqn:multiphysicsProblemSet3a:70}
\kbordermatrix{
                 & n_i & n_j  & i_{L_{n_i, n_j}} \\
n_i              &     &      & 1                \\
n_j              &     &      & -1               \\
i_{L_{n_i, n_j}} & -1  & 1    &                  \\
},
\end{equation}

and the \( \BC \) portion of that stamp with just

\begin{equation}\label{eqn:multiphysicsProblemSet3a:71}
\kbordermatrix{
                 & i_{L_{n_i, n_j}} \\
i_{L_{n_i, n_j}} & L                \\
}.
\end{equation}

The trickiest aspect of application of this stamp is likely determining the right rows and columns to allocate for each inductor current, leaving sufficient space for the voltage source currents rows and columns, as well as space for any voltage controlled voltage gain stamps.

See \nbcite{ps3a:NodalAnalysis.m}{ps3a/NodalAnalysis.m} for the matlab code to generate MNA equations also including capacitor and inductor support.

\makeSubAnswer{}{multiphysics:problemSet3a:1b}

\captionedTable{RLC values per segment}{tab:multiphysicsProblemSet3a:n}{
\begin{tabular}{|l||l|l|l|l|}
\hline
Level  & n        & R (\( \Omega \))  & Inductance (nH) & Capacitance (pF) \\ \hline
\hline
1      & 120.0000 & 0.1250            & 0.0250          & 0.0100 \\ \hline
2      & 80.0000  & 0.1785            & 0.0357          & 0.0070 \\ \hline
3      & 60.0000  & 0.2550            & 0.0510          & 0.0049 \\ \hline
4      & 40.0000  & 0.2550            & 0.0510          & 0.0049 \\ \hline
\end{tabular}
}

Code to implement the netlist for this circuit, including the terminating chip loads, have been implemented in \matlabFuncPath{generateNetlistSegmentForLevel}{ps3a:generateNetlistSegmentForLevel.m}(),
\matlabFuncPath{generateNetlistSegment}{ps3a:generateNetlistSegment.m}(), and
\matlabFuncPath{generateNetlist}{ps3a:generateNetlist.m}(), the last of which takes the filename for the netlist output.

\makeSubAnswer{}{multiphysics:problemSet3a:1c}

TODO.
\makeSubAnswer{}{multiphysics:problemSet3a:1d}

TODO.
\makeSubAnswer{}{multiphysics:problemSet3a:1e}

TODO.
\makeSubAnswer{}{multiphysics:problemSet3a:1f}

TODO.
}
