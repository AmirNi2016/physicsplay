\documentclass{article}

\usepackage{listings}
\usepackage{framed}
\usepackage{xcolor}
\usepackage{amsmath}
\colorlet{shadecolor}{gray!20}

\lstnewenvironment{mat}
{\lstset{language=mathematica,mathescape,columns=flexible}}
{}

% caption, label, content
\newcommand{\mathematicaListing}[3]{%
%\begin{figure}%
%\caption{#1}\label{#2}%
\begin{shaded}%
\begin{mat}%
\end{mat}%
\end{shaded}%
%\end{figure}%
}

\begin{document}

%\begin{figure}
%\caption{Plot methods for fields and intensities}\label{eqn:chapter2Notes:600}
%\begin{shaded}
%\begin{mat}
%rcap = {Cos[#], Sin[#]} & ;
%scap = {Sin[#1] Cos[#2], Sin[#1] Sin[#2], Cos[#1]} & ;
%ParametricPlot[ f[$r_0$, $\theta$, 0] rcap, {$\theta$, 0, Pi}]
%ParametricPlot3D[ f[$r_0$, $\theta$, $\phi$] scap, {$\theta$, 0, Pi}, {$\phi$, 0, 2 Pi}]
%\end{mat}
%\end{shaded}
%\end{figure}

% not okay:
%\mathematicaListing{blah}{eqn:chapter2Notes:800}{foo = 1 ;}

%\mathematicaListing{blah}{eqn:chapter2Notes:800} %{foo}
\begin{figure}
\caption{blah}\label{eqn:chapter2Notes:800}
\mathematicaListing{blah}{eqn:chapter2Notes:800}{foo = 0 ;}
\end{figure}

%\mathematicaListing{blah}{eqn:chapter2Notes:900}{scap = {Sin[#1] Cos[#2], Sin[#1] Sin[#2], Cos[#1]} & ;}

\end{document}
