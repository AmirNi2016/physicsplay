%
% Copyright © 2012 Peeter Joot.  All Rights Reserved.
% Licenced as described in the file LICENSE under the root directory of this GIT repository.
%

\chapter{Hamiltonian notes}
\label{chap:hamiltonian}
%\blogpage{http://sites.google.com/site/peeterjoot/math2009/hamiltonian.pdf?revision=6}
%\date{Sept 26, 2009}

\section{Motivation}

I have now seen Hamiltonian's used, mostly in a Quantum context, and think that I understand at least some of the math associated with the Hamiltonian and the Hamiltonian principle.  I have, however, not used either of these enough that it seems natural to do so.

Here I attempt to summarize for myself what I know about Hamiltonian's, and work through a number of examples.  Some of the examples considered will be ones already treated with the Lagrangian formalism \bookchapcite{PJTongMf1}{phy354}.

Some notation will be invented along the way as reasonable, since I had like to try to also relate the usual coordinate representation of the Hamiltonian, the Hamiltonian principle, and the Poisson bracket, with the bivector representation of the 2N complex configuration space introduced in \citep{doran2003gap}. (NOT YET DONE).

\section{Hamiltonian as a conserved quantity}

Starting with the Lagrangian formalism the Hamiltonian can be found as a conserved quantity associated with time translation when the Lagrangian has no explicit time dependence.  This follows directly by considering the time derivative of the Lagrangian $\LL = \LL(q^i, \qdot^i)$.

\begin{align*}
\frac{d\LL}{dt}
&= \PD{q^i}{\LL} \frac{dq^i}{dt} +\PD{\qdot^i}{\LL} \frac{d\qdot^i}{dt} \\
&= \qdot^i \frac{d}{dt}\PD{\qdot^i}{\LL} +\PD{\qdot^i}{\LL} \frac{d\qdot^i}{dt} \\
&= \frac{d}{dt} \left( \qdot^i \PD{\qdot^i}{\LL} \right)
\end{align*}

We can therefore form the difference

\begin{align}\label{eqn:hamiltonian:foo1}
\frac{d}{dt} \left( \qdot^i \PD{\qdot^i}{\LL} -\LL \right) = 0
\end{align}

and find that this quantity, labeled H, is a constant of motion for the system

\begin{align}\label{eqn:hamiltonian:foo2}
H \equiv \qdot^i \PD{\qdot^i}{\LL} -\LL = \text{constant}
\end{align}

We will see later that this constant is sometimes the total energy of the system.

The $\qdot^i$ partials of the Lagrangian are called the canonical momentum conjugate to $q^i$.  Quite a mouthful, so just canonical momenta seems like a good compromise.  We will write (reserving $p^i = m q^i$ for the non-canonical momenta)

\begin{align}\label{eqn:hamiltonian:foo2b}
P_i \equiv \PD{\qdot^i}{\LL}
\end{align}

and note that these are the coordinates of a sort of velocity gradient of the Lagrangian.  We have seen these canonical momenta in velocity gradient form previously where it was noted that we could write the Euler-Lagrange equations in vector form in an orthonormal reciprocal frame space as

\begin{align}\label{eqn:hamiltonian:foo9}
\grad \LL = \frac{d}{dt} \grad_v \LL
\end{align}

where $\grad_v = e^i \partial \LL/\partial \xdot^i = e^i P_i$, $\grad = e^i \partial/\partial x^i$, and $x = e_i x^i$.

%Here we will be exploring phase space relationships where the position and velocity basis pairs are treated independently, but also will not have much requirement for direct use of the Euler Lagrange equations.

\section{Some syntactic sugar.  In vector form}

Following Jackson \citep{jackson1975cew} (section 12.1, relativistic Lorentz force Hamiltonian), this can be written in vector form if the velocity gradient, the vector sum of the momenta conjugate to the $q^i$'s is given its own symbol $\BP$.  He writes

\begin{align}\label{eqn:hamiltonian:foo3}
H = \Bv \cdot \BP - \LL
\end{align}

This makes most sense when working in orthonormal coordinates, but can be generalized.  Suppose we introduce a pair of reciprocal frame basis for the generalized position and velocity coordinates, writing as vectors in configuration space

\begin{align}\label{eqn:hamiltonian:foo4}
q &= e_i q^i \\
v &= f_i \qdot^i
\end{align}

Following \citep{doran2003gap} (who use this for their bivector complexification of the configuration space), we have the freedom to impose orthonormal constraints on this configuration space basis

\begin{align}\label{eqn:hamiltonian:foo5}
e^i \cdot e_j &= {\delta^i}_j \\
f^i \cdot f_j &= {\delta^i}_j \\
e^i \cdot f_j &= {\delta^i}_j
\end{align}

We can now define configuration space position and velocity gradients

\begin{align}\label{eqn:hamiltonian:foo6}
\grad &\equiv e^i \PD{q^i}{} \\
\grad_v &\equiv f^i \PD{\qdot^i}{}
\end{align}

so the conjugate momenta in vector form is now

\begin{align}\label{eqn:hamiltonian:foo7}
P \equiv \grad_v \LL = f^i \PD{\qdot^i}{\LL}
\end{align}

Our Hamiltonian takes the form

\begin{align}\label{eqn:hamiltonian:foo8}
H = v \cdot P - \LL
\end{align}

\section{The Hamiltonian principle}

We want to take partials of \eqnref{eqn:hamiltonian:foo2} with respect to $P_i$ and $q^i$.  In terms of the canonical momenta we want to differentiate

\begin{align}\label{eqn:hamiltonian:hoo1}
H \equiv \qdot^i P_i -\LL(q^i, \qdot^i, t)
\end{align}

for the $P_i$ partial we have

\begin{align*}
\PD{P_i}{H} = \qdot^i
\end{align*}

and for the $q^i$ partial

\begin{align*}
\PD{q^i}{H}
&= -\PD{q^i}{\LL} \\
&= - \frac{d}{dt} \PD{\qdot^i}{\LL}
\end{align*}

These two results taken together form what I believe is called the Hamiltonian principle

\begin{align}\label{eqn:hamiltonian:hoo3}
\PD{P_i}{H} &= \qdot^i \\
\PD{q^i}{H} &= - \dot{P}_i \\
P_i &= \PD{\qdot^i}{\LL}
\end{align}

A set of 2N first order equations equivalent to the second order Euler-Lagrange equations.  These appear to follow straight from the definitions.  Given that I am curious why the more complex method of derivation is chosen in \citep{goldstein1951cm}.  There the total differential of the Hamiltonian is computed

\begin{align*}
dH &=
\qdot^i dP_i
+ d\qdot^i P_i
- dq^i \PD{q^i}{\LL}
- d \qdot^i \PD{\qdot^i}{\LL}
- dt \PD{t}{\LL} \\
&=
\qdot^i dP_i
+ d\qdot^i \left( P_i - \PD{\qdot^i}{\LL} \right)
- dq^i \PD{q^i}{\LL}
- dt \PD{t}{\LL} \\
&=
\qdot^i dP_i
- dq^i 
\mathLabelBox
[
   labelstyle={below of=m\themathLableNode, below of=m\themathLableNode}
]
{\PD{q^i}{\LL}}{$= dP_i/dt$}
- dt \PD{t}{\LL} \\
\end{align*}

A term by term comparison to the total differential written out explicitly

\begin{align}\label{eqn:hamiltonian:hoo4}
dH &=
\PD{q^i}{H} d q^i
+\PD{P_i}{H} d P_i
+\PD{t}{H} dt
\end{align}

allows the Hamiltonian equations to be picked off.

\begin{align}\label{eqn:hamiltonian:hoo5}
\PD{P_i}{H} &= \qdot^i  \\
\PD{q^i}{H} &= - \dot{P}_i  \\
\PD{t}{H}   &= - \PD{t}{\LL}
\end{align}

I guess that is not that much more complicated and it does yield a relation between the Hamiltonian and Lagrangian time derivatives.

\section{Examples}

Now, that is just about the most abstract way we can start things off is not it?  Getting some initial feel for this constant of motion can be had by considering a sequence of Lagrangians, starting with the very simplest.

\subsection{Force free motion}

Our very simplest Lagrangian is that of one dimensional purely kinetic motion

\begin{align}\label{eqn:hamiltonian:boo1}
\LL = \inv{2} m v^2 = \inv{2} m \xdot^2
\end{align}

Our Hamiltonian is in this case just

\begin{align}\label{eqn:hamiltonian:boo2}
H = \xdot m \xdot - \inv{2} m \xdot = \inv{2} m v^2
\end{align}

The Hamiltonian is just the kinetic energy.  The canonical momentum in this case is also equal to the momentum, so eliminating $v$ to apply the Hamiltonian equations we have

\begin{align}\label{eqn:hamiltonian:boo3}
H = \inv{2m} p^2
\end{align}

We have then

\begin{align*}
\PD{p}{H} &= \frac{p}{m} = \dot{x} \\
\PD{x}{H} &= 0 = -\dot{p}
\end{align*}

Just for fun we can put this simple linear system in matrix form

\begin{align}\label{eqn:hamiltonian:boo4}
\frac{d}{dt}
\begin{bmatrix}
p \\
x
\end{bmatrix}
=
\inv{m}
\begin{bmatrix}
0 & 0 \\
1 & 0
\end{bmatrix}
\begin{bmatrix}
p \\
x
\end{bmatrix}
\end{align}

A linear system of this form $y' = A y$ can be solved by exponentiation with solution

\begin{align}\label{eqn:hamiltonian:boo5}
y = e^{A t} y_0
\end{align}

In this case our matrix is nilpotent degree 2 so we can exponentiate only requiring up to the first order power

\begin{align}\label{eqn:hamiltonian:boo6}
e^{A t} = I + A t
\end{align}

specifically

\begin{align}\label{eqn:hamiltonian:boo7}
\begin{bmatrix}
p \\
x
\end{bmatrix}
=
\begin{bmatrix}
1 & 0 \\
\frac{t}{m} & 1
\end{bmatrix}
\begin{bmatrix}
p_0 \\
x_0
\end{bmatrix}
\end{align}

Written out in full this is just

\begin{align}\label{eqn:hamiltonian:boo8}
p &= p_0 \\
x &= \frac{p_0}{m} t + x_0
\end{align}

Since the canonical momentum is the regular momentum $p = m v$ in this case, we have the usual constant rate change of position $x = v_0 t + x_0$ that we could have gotten in many easier ways.  I had hazard a guess that any single variable Lagrangian that is at most quadratic in position or velocity will yield a linear system.

The generalization of this Hamiltonian to three dimensions is straightforward, and we get

\begin{align}\label{eqn:hamiltonian:boo9}
H &= \inv{m} \Bp^2
\end{align}

\begin{align}\label{eqn:hamiltonian:boo10}
\frac{d}{dt}
\begin{bmatrix}
p_x \\
x \\
p_y \\
y \\
p_z \\
z \\
\end{bmatrix}
=
\inv{m}
\begin{bmatrix}
0 & 0 &   &   &   &   \\
1 & 0 &   &   &   &   \\
  &   & 0 & 0 &   &   \\
  &   & 1 & 0 &   &   \\
  &   &   &   & 0 & 0 \\
  &   &   &   & 1 & 0 \\
\end{bmatrix}
\begin{bmatrix}
p_x \\
x \\
p_y \\
y \\
p_z \\
z \\
\end{bmatrix}
\end{align}

Since there is no coupling (nilpotent matrices down the diagonal) between the coordinates this can be treated as three independent sets of equations of the form \eqnref{eqn:hamiltonian:boo4}, and we have

\begin{align}\label{eqn:hamiltonian:boo11}
p_i(t) &= p_i(0) \\
x_i(t) &= \frac{p_i(0)}{m} t + x_i(0)
\end{align}

Or just

\begin{align}\label{eqn:hamiltonian:boo12}
\Bp(t) &= \Bp(0) \\
\Bx(t) &= \frac{\Bp(0)}{m} t + \Bx(0)
\end{align}

\subsection{Linear potential (surface gravitation)}

For the gravitational force $F = - m g \zcap = - \spacegrad \phi$, we have $\phi = m g z$, and a Lagrangian of

\begin{align}\label{eqn:hamiltonian:roo1}
\LL = \inv{2} m \Bv^2 - \phi = \inv{2} m \Bv^2 - m g z
\end{align}

Without velocity dependence the canonical momentum is the momentum $m \Bv$, and our Hamiltonian is

\begin{align}\label{eqn:hamiltonian:roo2}
H = \inv{2 m} \Bp^2 + m g z
\end{align}

The Hamiltonian equations are

\begin{align}\label{eqn:hamiltonian:roo3}
\PD{p_i}{H} &= \xdot_i = \inv{m} p_i \\
\sigma_i \PD{x_i}{H} &= -\sigma_i \pdot_i = \begin{bmatrix}0 \\ 0 \\ m g \end{bmatrix}
\end{align}

In matrix form we have

\begin{align}\label{eqn:hamiltonian:roo4}
\frac{d}{dt}
\begin{bmatrix}
p_x \\
x \\
p_y \\
y \\
p_z \\
z \\
\end{bmatrix}
=
\inv{m}
\begin{bmatrix}
0 & 0 &   &   &   &   \\
1 & 0 &   &   &   &   \\
  &   & 0 & 0 &   &   \\
  &   & 1 & 0 &   &   \\
  &   &   &   & 0 & 0 \\
  &   &   &   & 1 & 0 \\
\end{bmatrix}
\begin{bmatrix}
p_x \\
x \\
p_y \\
y \\
p_z \\
z \\
\end{bmatrix}
+
\begin{bmatrix}
0 \\
0 \\
0 \\
0 \\
-m g \\
0 \\
\end{bmatrix}
\end{align}

So our problem is now reduced to solving a linear system of the form

\begin{align}\label{eqn:hamiltonian:roo5}
y' = A y + b
\end{align}

That extra little term $b$ throws a wrench into things and I am no longer sure how to integrate by inspection.  What can be noted is that we really only have to consider the $z$ components since we have solved the problem for the $x$ and $y$ coordinates in the force free case.  That leaves

\begin{align}\label{eqn:hamiltonian:roo6}
\frac{d}{dt}
\begin{bmatrix}
p_z \\
z \\
\end{bmatrix}
=
\inv{m}
\begin{bmatrix}
0 & 0 \\
1 & 0 \\
\end{bmatrix}
\begin{bmatrix}
p_z \\
z \\
\end{bmatrix}
+
\begin{bmatrix}
-m g \\
0 \\
\end{bmatrix}
\end{align}

Is there any reason that we have to solve in matrix form?  Except for a coolness factor, not really, and we can integrate each equation directly.  For the momentum equation we have

\begin{align}\label{eqn:hamiltonian:roo7}
p_z = - m g t + p_z(0)
\end{align}

This can be substituted into the position equation for

\begin{align}\label{eqn:hamiltonian:roo8}
\dot{z} = \inv{m} (p_z(0) - m g t)
\end{align}

Direct integration is now possible for the final solution

\begin{align*}
z
&= \inv{m} (p_z(0) t - m g t^2/2) + z_0 \\
&= \frac{p_z(0)}{m} t - \frac{g}{2} t^2 + z_0
\end{align*}

Again something that we could have gotten in many easier ways.  Using the result we see that the solution to \eqnref{eqn:hamiltonian:roo6} in matrix form, again with $A = \inv{m}\begin{bmatrix}0 & 0 \\ 1 & 0\end{bmatrix}$ is

\begin{align}\label{eqn:hamiltonian:roo9}
\begin{bmatrix}
p_z \\
z \\
\end{bmatrix}
= e^{At}
\begin{bmatrix}
p_z(0) \\
z(0) \\
\end{bmatrix}
- m g
\begin{bmatrix}
t \\
\inv{2m} t^2
\end{bmatrix}
\end{align}

I thought if I wrote this out how to solve \eqnref{eqn:hamiltonian:roo5} may be more obvious, but that path is still unclear.  If $A$ were invertible, which it is not, then writing $b = A c$ would allow for a change of variables.  Does this matter for consideration of a physical problem.  Not really, so I will fight the urge to play with the math for a while and perhaps revisit this later separately.

\subsection{Harmonic oscillator (spring potential)}

Like the free particle, the harmonic oscillator is very tractable in a phase space representation.  For a restoring force $F = - k x \xcap = -\spacegrad \phi$, we have $\phi = k x^2/2$, and a Lagrangian of

\begin{align}\label{eqn:hamiltonian:woo1}
\LL = \inv{2} m \Bv^2 - \inv{2} k \Bx^2
\end{align}

Our Hamiltonian is again just the total energy

\begin{align}\label{eqn:hamiltonian:woo2}
H = \inv{2m} \Bp^2 + \inv{2} k \Bx^2
\end{align}

Evaluating the Hamiltonian equations we have

\begin{align}\label{eqn:hamiltonian:woo3}
\PD{p_i}{H} &= \dot{x_i} = p_i/m \\
\PD{x_i}{H} &= -\dot{p_i} = k x_i
\end{align}

Considering just the $x$ dimension (the others have the free particle behavior), our matrix phase space representation is

\begin{align}\label{eqn:hamiltonian:woo4}
\frac{d}{dt}
\begin{bmatrix}
p \\
x \\
\end{bmatrix}
=
\begin{bmatrix}
0 & - k \\
1/m & 0 \\
\end{bmatrix}
\begin{bmatrix}
p \\
x \\
\end{bmatrix}
\end{align}

So with

\begin{align}\label{eqn:hamiltonian:woo5}
A =
\begin{bmatrix}
0 & - k \\
1/m & 0 \\
\end{bmatrix}
\end{align}

Our solution is

\begin{align}\label{eqn:hamiltonian:woo6}
\begin{bmatrix}
p \\
x \\
\end{bmatrix}
=
e^{At}
\begin{bmatrix}
p_0 \\
x_0 \\
\end{bmatrix}
\end{align}

The stateful nature of the phase space solution is interesting.  Provided we can make a simultaneous measurement of position and momentum, this initial state determines a next position and momentum state at a new time $t = t_0 + \Delta t_1$, and we have a trajectory through phase space of discrete transitions from one state to another

\begin{align}\label{eqn:hamiltonian:woo6a}
{\begin{bmatrix}
p \\
x \\
\end{bmatrix}}_{i+1}
=
e^{A \Delta t_{i+1}}
{\begin{bmatrix}
p \\
x \\
\end{bmatrix}}_i
\end{align}

Or

\begin{align}\label{eqn:hamiltonian:woo6b}
{\begin{bmatrix}
p \\
x \\
\end{bmatrix}}_{i+1}
=
e^{A \Delta t_{i+1}} e^{A \Delta t_{i}} \cdots e^{A \Delta t_1}
{\begin{bmatrix}
p \\
x \\
\end{bmatrix}}_0
\end{align}

As for solving the system, we require again the exponential of our matrix.  This matrix being antisymmetric, has complex eigenvalues and again cannot be exponentiated easily by diagonalization.  However,  this antisymmetric matrix is very much like the complex imaginary and its square is a negative scalar multiple of identity, so we can proceed directly forming the power series

\begin{align}\label{eqn:hamiltonian:woo7}
A^2 =
\begin{bmatrix}
0 & - k \\
1/m & 0 \\
\end{bmatrix}
\begin{bmatrix}
0 & - k \\
1/m & 0 \\
\end{bmatrix}
=
-\frac{k}{m} I
\end{align}

The first few powers are
\begin{align}\label{eqn:hamiltonian:woo8}
A^2 &= -\frac{k}{m} I \\
A^3 &= -\frac{k}{m} A \\
A^4 &= \left(\frac{k}{m}\right)^2 I \\
A^5 &= \left(\frac{k}{m}\right)^2 A
\end{align}

So exponentiating we can collect cosine and sine terms
\begin{align*}
e^{At}
&= I \left( 1 - \frac{k}{m} \frac{t^2}{2!} + \left( \frac{k}{m} \right)^2 \frac{t^4}{4!} + \cdots \right)
+ A\sqrt{\frac{m}{k}} \left( \sqrt{\frac{k}{m}} - \left(\sqrt{\frac{k}{m}}\right)^3 \frac{t^3}{3!} + \left(\sqrt{\frac{k}{m}}\right)^5 \frac{t^5}{5!} \right) \\
&=
I \cos\left(\sqrt{\frac{k}{m}} t\right) + \sqrt{\frac{m}{k}} A \sin\left(\sqrt{\frac{k}{m}} t\right)
\end{align*}

As a check it is readily verified that this satisfies the desired $d(e^{At})/dt = A e^{At}$ property.

The full solution in phase space representation is therefore

\begin{align}\label{eqn:hamiltonian:woo9}
\begin{bmatrix}
p \\
x \\
\end{bmatrix}
=
\begin{bmatrix}
p_0 \\
x_0 \\
\end{bmatrix}
\cos\left(\sqrt{\frac{k}{m}} t\right)
+ \sqrt{\frac{m}{k}}
\begin{bmatrix}
-k x_0 \\
p_0/m \\
\end{bmatrix}
\sin\left(\sqrt{\frac{k}{m}} t\right)
\end{align}

Written out separately this is clearer

\begin{align}\label{eqn:hamiltonian:woo10}
p &= p_0 \cos\left(\sqrt{\frac{k}{m}} t\right) - \sqrt{\frac{m}{k}} k x_0 \sin\left(\sqrt{\frac{k}{m}} t\right) \\
x &= x_0 \cos\left(\sqrt{\frac{k}{m}} t\right) + \sqrt{\frac{m}{k}} \frac{p_0}{m} \sin\left(\sqrt{\frac{k}{m}} t\right)
\end{align}

One can readily verify that $m \xdot = p$, and $m \ddot{x} = -k x$ as expected.

Let us pause before leaving the harmonic oscillator to see if \eqnref{eqn:hamiltonian:woo10} seems to make sense.  Consider the position solution.  With only initial position and no initial velocity $p_0/m$ we have oscillation that has no dependence on the mass or spring constant.  This is the unmoving mass about to be let go at the end of a spring case, and since we have no damping force the magnitude of the oscillation is exactly the initial position of the mass.  If the instantaneous velocity is measured at position zero, it makes sense in this case that the oscillation amplitude does depend on both the mass and the spring constant.  The stronger the spring ($k$), the bigger the oscillation, and the smaller the mass, the bigger the oscillation.

It is definitely no easier to work with the phase space formulation than just solving the second order system directly.  The fact that we have a linear system to solve, at least in this particular case is kind of nice.  Perhaps this methodology can be helpful considering linear approximation solutions in a neighborhood of some phase space point for more complex non-linear systems.

\subsection{Harmonic oscillator (change of variables.)}

It was pointed out to me by Lut that the following rather strange looking change of variables has nice properties

\begin{align}\label{eqn:hamiltonian:zoo1}
P &= x \sqrt{\frac{k}{2}} + \frac{ p }{\sqrt{2 m}} \\
Q &= x \sqrt{\frac{k}{2}} - \frac{ p }{\sqrt{2 m}}
\end{align}

In particular the Hamiltonian is then just

\begin{align}\label{eqn:hamiltonian:zoo2}
H = P^2 + Q^2
\end{align}

Part of this change of variables, which rotates in phase space, as well as scales, looks like just a way of putting the system into natural units.  We do not however, need the rotation to do that.  Suppose we write for just the scaling change of variables

\begin{align}\label{eqn:hamiltonian:zoo3}
p &= \sqrt{2m} P_s \\
x &= \sqrt{\frac{2}{k}} Q_s
\end{align}

or

\begin{align}\label{eqn:hamiltonian:zoo5}
\begin{bmatrix}
p \\
x \\
\end{bmatrix}
=
\begin{bmatrix}
\sqrt{2m} & 0 \\
0 & \sqrt{\frac{2}{k}}
\end{bmatrix}
\begin{bmatrix}
P_s \\
Q_s \\
\end{bmatrix}
\end{align}

This also gives the Hamiltonian \eqnref{eqn:hamiltonian:zoo2}, and the Hamiltonian equations are transformed to

\begin{align*}
\frac{d}{dt}
\begin{bmatrix}
P_s \\
Q_s \\
\end{bmatrix}
&=
\begin{bmatrix}
1/\sqrt{2m} & 0 \\
0 & \sqrt{\frac{k}{2}}
\end{bmatrix}
\begin{bmatrix}
0 & - k \\
1/m & 0 \\
\end{bmatrix}
\begin{bmatrix}
\sqrt{2m} & 0 \\
0 & \sqrt{\frac{2}{k}}
\end{bmatrix}
\begin{bmatrix}
P_s \\
Q_s \\
\end{bmatrix} \\
&=
\begin{bmatrix}
0 & - \sqrt{\frac{k}{m}} \\
\sqrt{\frac{k}{m}} & 0 \\
\end{bmatrix}
\begin{bmatrix}
P_s \\
Q_s \\
\end{bmatrix}
\end{align*}

This first change of variables is nice since it groups the two factors $k$ and $m$ into a reciprocal pair.  Since only the ratio is significant to the kinetics it is nice to have that explicit.  Since $\sqrt{k/m}$ is in fact the angular frequency, we can define

\begin{align}\label{eqn:hamiltonian:zoo6}
\omega \equiv \sqrt{\frac{k}{m}}
\end{align}

and our system is reduced to

\begin{align}\label{eqn:hamiltonian:zoo7}
\frac{d}{dt}
\begin{bmatrix}
P_s \\
Q_s \\
\end{bmatrix}
&=
\omega
\begin{bmatrix}
0 & -1 \\
1 & 0
\end{bmatrix}
\begin{bmatrix}
P_s \\
Q_s \\
\end{bmatrix}
\end{align}

Solution of this system now becomes particularly easy, especially if one notes that the matrix factor above can be expressed in terms of the $y$ axis Pauli matrix $\sigma_2$.  That is

\begin{align}\label{eqn:hamiltonian:zoo8}
\sigma_2 =
i
\begin{bmatrix}
0 & -1 \\
1 & 0
\end{bmatrix}
\end{align}

Inverting this, and labeling this matrix $\mathcal{I}$ we can write

\begin{align}\label{eqn:hamiltonian:zoo9}
\mathcal{I} \equiv
\begin{bmatrix}
0 & -1 \\
1 & 0
\end{bmatrix}
=
-i \sigma_2
\end{align}

Recalling that $\sigma_2^2 = I$, we then have $\mathcal{I}^2 = -I$, and see that this matrix behaves exactly like a unit imaginary.  This reduces the Hamiltonian system to

\begin{align}\label{eqn:hamiltonian:zoo10}
\frac{d}{dt}
\begin{bmatrix}
P_s \\
Q_s \\
\end{bmatrix}
&=
\mathcal{I} \omega
\begin{bmatrix}
P_s \\
Q_s \\
\end{bmatrix}
\end{align}

We can now solve the system directly.  Writing $\Bz_s = \bigl(\begin{smallmatrix} P_s \\ Q_s \\ \end{smallmatrix}\bigr)$, this is just

\begin{align}\label{eqn:hamiltonian:zoo11}
\Bz_s(t)
=
e^{\mathcal{I} \omega t} \Bz_s(0)
&=
\left( I \cos(\omega t) + \mathcal{I} \sin(\omega t) \right) \Bz_s(0)
\end{align}

With just the scaling giving both the simple Hamiltonian, and a simple solution, what is the advantage of the further change of variables that mixes (rotates in phase space by 45 degrees with a factor of two scaling) the momentum and position coordinates?  That second transformation is

\begin{align}\label{eqn:hamiltonian:zoo1a}
P &= Q_s + P_s \\
Q &= Q_s - P_s
\end{align}

Inverting this we have

\begin{align}\label{eqn:hamiltonian:zoo12}
\begin{bmatrix}
P_s \\
Q_s \\
\end{bmatrix}
=
\inv{2}
\begin{bmatrix}
1 & -1 \\
1 & 1 \\
\end{bmatrix}
\begin{bmatrix}
P \\
Q \\
\end{bmatrix}
\end{align}

The Hamiltonian after this change of variables is now

\begin{align}\label{eqn:hamiltonian:zoo13}
\frac{d}{dt}
\begin{bmatrix}
P \\
Q \\
\end{bmatrix}
&=
\frac{\omega}{2}
\begin{bmatrix}
1 & 1 \\
-1 & 1 \\
\end{bmatrix}
\begin{bmatrix}
0 & -1 \\
1 & 0 \\
\end{bmatrix}
\begin{bmatrix}
1 & -1 \\
1 & 1 \\
\end{bmatrix}
\begin{bmatrix}
P \\
Q \\
\end{bmatrix}
\end{align}

But multiplying this out one finds that the equations of motion for the state space vector are unchanged by the rotation, and writing $\Bz = \bigl(\begin{smallmatrix} P \\ Q \\ \end{smallmatrix}\bigr)$ for the state vector, the Hamiltonian equations are

\begin{align}\label{eqn:hamiltonian:zoo14}
\Bz' = \mathcal{I} \omega \Bz
\end{align}

This is just as we had before the rotation-like mixing of position and momentum coordinates.  Now it looks like the rotational change of coordinates is related to the raising and lowering operators in the Quantum treatment of the Harmonic oscillator, but it is not clear to me what the advantage is in the classical context?  Perhaps the point is, that at least for the classical Harmonic oscillator, we are free to rotate the phase space vector arbitrarily and not change the equations of motion.  A restriction to the classical domain is required since squaring the results of this 45 degree rotation of the phase space vector requires commutation of the position and momentum coordinates in order for the cross terms to cancel out.

Is there a deeper meaning to this rotational freedom?  It seems to me that one ought to be able to relate the rotation and the quantum ladder operators in a more natural way, but it is not clear to me exactly how.

\subsection{Force free system dependent on only differences}

In gravitational and electrostatic problems are forces are all functions of only the difference in positions of the particles.  Lets look at how the purely kinetic Lagrangian and Hamiltonian change when one or more of the vector positions is reexpressed in terms of a difference in position change of variables.  In the force free case this is primarily a task of rewriting the Hamiltonian in terms of the conjugate momenta after such a change of variables.

The very simplest case is the two particle single dimensional Kinetic Lagrangian,

\begin{align}\label{eqn:hamiltonian:noo1}
\LL = \inv{2} m_1 {\rdot_1}^2 + \inv{2} m_2 {\rdot_2}^2
\end{align}

With a change of variables

\begin{align}\label{eqn:hamiltonian:noo2}
x &= r_2 - r_1 \\
y &= r_2
\end{align}

and elimination of $r_1$, and $r_2$ we have

\begin{align}\label{eqn:hamiltonian:noo3}
\LL = \inv{2} m_1 (\ydot - \xdot)^2 + \inv{2} m_2 {\ydot}^2
\end{align}

We now need the conjugate momenta in terms of $\xdot$ and $\ydot$.  These are

\begin{align}\label{eqn:hamiltonian:noo4}
P_x &= \PD{\xdot}{\LL} = -m_1 (\ydot - \xdot) \\
P_y &= \PD{\ydot}{\LL} = m_1 (\ydot - \xdot) + m_2 \ydot
\end{align}

We must now rewrite the Lagrangian in terms of $P_x$ and $P_y$, essentially requiring the inversion of this which amounts to the inversion of the two by two linear system of \eqnref{eqn:hamiltonian:noo4}.  That is

\begin{align}\label{eqn:hamiltonian:noo5}
\begin{bmatrix}
\xdot \\
\ydot
\end{bmatrix}
=
{\begin{bmatrix}
m_1 & -m_1 \\
-m_1 & (m_1 + m_2) \\
\end{bmatrix}}^{-1}
\begin{bmatrix}
P_x \\
P_y
\end{bmatrix}
\end{align}

This is

\begin{align}\label{eqn:hamiltonian:noo6}
\begin{bmatrix}
\xdot \\
\ydot
\end{bmatrix}
=
\inv{m_1}\inv{m_2}
\begin{bmatrix}
m_1 + m_2 & m_1 \\
m_1 & m_1 \\
\end{bmatrix}
\begin{bmatrix}
P_x \\
P_y
\end{bmatrix}
\end{align}

Of these only $\ydot$ and $\ydot - \xdot$ are of interest and after a bit of manipulation we find

\begin{align}\label{eqn:hamiltonian:noo7}
\ydot &= \inv{m_2}(P_x + P_y) \\
\xdot &= \inv{m_1}\inv{m_2}((m_1 + m_2)P_x + m_1 P_y)
\end{align}

From this we find the Lagrangian in terms of the conjugate momenta

\begin{align}\label{eqn:hamiltonian:noo8}
\LL = \inv{2 m_1} {P_x}^2 + \inv{2 m_2} (P_x + P_y)^2
\end{align}

A quick check shows that $P_x + P_y = m_2 \rdot_2$, and $P_x = -m_1 \rdot_1$, so we have agreement with the original Lagrangian.  Generalizing to the three dimensional case is straightforward, and we have

\begin{align}\label{eqn:hamiltonian:noo9}
\LL &= \inv{2} m_1 {\mathbf{\rdot}_1}^2 + \inv{2} m_2 {\mathbf{\rdot}_2}^2 - \phi(\Bx_1 - \Bx_2)
\end{align}

With
\begin{align}\label{eqn:hamiltonian:noo10}
\Bx &= \Bx_1 - \Bx_2 \\
\By &= \Bx_2
\end{align}

The 3D generalization of the above (following by adding indices then summing) becomes

\begin{align}\label{eqn:hamiltonian:noo11}
\BP_x &= \sigma_j \PD{\xdot^j}{\LL} = -m_1 (\mathbf{\ydot} - \mathbf{\xdot}) \\
\BP_y &= \sigma_j \PD{\ydot^j}{\LL} = m_1 (\mathbf{\ydot} - \mathbf{\xdot}) + m_2 \mathbf{\ydot}
\end{align}

\begin{align}\label{eqn:hamiltonian:noo12}
\LL &= \inv{2 m_1} {\BP_x}^2 + \inv{2 m_2} (\BP_x + \BP_y)^2 - \phi(\Bx) \\
H &= \inv{2 m_1} {\BP_x}^2 + \inv{2 m_2} (\BP_x + \BP_y)^2 + \phi(\Bx)
\end{align}

Finally, evaluation of the Hamiltonian equations we have

\begin{align*}
\sigma_j \PD{P_x^j}{H} &= \mathbf{\xdot} \\
&= \sigma_j \left( \inv{m_1} P_x^j + \inv{m_2} (P_x^j + P_y^j) \right) \\
&= \inv{m_1} \BP_x + \inv{m_2} (\BP_x + \BP_y)
\end{align*}

\begin{align*}
\sigma_j \PD{P_y^j}{H} &= \mathbf{\ydot} \\
&= \sigma_j \inv{m_2} (P_x^j + P_y^j) \\
&= \inv{m_2} (\BP_x + \BP_y)
\end{align*}

\begin{align*}
\sigma_j \PD{x^j}{H} &= -\mathbf{\dot{P}}_x \\
&= -\sigma_j \PD{x^j}{\phi} \\
&= -\spacegrad_{\Bx} \phi(\Bx)
\end{align*}

\begin{align*}
\sigma_j \PD{y^j}{H} &= -\mathbf{\dot{P}}_y \\
&= -\sigma_j \PD{y^j}{\phi} \\
&= 0
\end{align*}

Summarizing we have four first order equations

\begin{align}\label{eqn:hamiltonian:noo13}
\mathbf{\xdot} &= \left( \inv{m_1} + \inv{m_2} \right) \BP_x + \inv{m_2} \BP_y \\
\mathbf{\ydot} &= \inv{m_2} (\BP_x + \BP_y)  \\
\mathbf{\dot{P}}_x &= \spacegrad_{\Bx} \phi(\Bx) \\
\mathbf{\dot{P}}_y &= 0
\end{align}

FIXME: what would we get if using the center of mass position as one of the variables.  A parametrization with three vector variables should also still work, even if it includes additional redundancy.

\subsection{Gravitational potential}

Next I had like to consider a two particle gravitational interaction.  However, to start we need the Lagrangian, and what should the potential term be in a two particle gravitational Lagrangian?  I had guess something with a $1/x$ form, but do we need one potential term for each mass or something interrelated?  Whatever the Lagrangian is, we want it to produce the pair of force relationships

\begin{align}\label{eqn:hamiltonian:moo1}
\text{Force on 2} &= - G m_1 m_2 \frac{(\Br_2 - \Br_1)}{\Abs{\Br_2 - \Br_1}} \\
\text{Force on 1} &= G m_1 m_2 \frac{(\Br_2 - \Br_1)}{\Abs{\Br_2 - \Br_1}}
\end{align}

Guessing that the Lagrangian has a single term for the interaction potential

\begin{align}\label{eqn:hamiltonian:moo2}
\phi_{21} &= \kappa \inv{\Abs{\Br_2 - \Br_1}}
\end{align}

so that we have
\begin{align}\label{eqn:hamiltonian:moo3}
\LL &= \inv{2} m {\Bv_1}^2 +\inv{2} m {\Bv_2}^2 - \phi_{21}
\end{align}

We can evaluate the Euler-Lagrange equations and see if the result is consistent with the Newtonian force laws of \eqnref{eqn:hamiltonian:moo1}.  Suppose we write the coordinates of $\Br_i$ as ${x^k}_i$.  There are then six Euler-Lagrange equations

\begin{align*}
\PD{{x^j}_i}{\LL} &= \frac{d}{dt} \PD{{\dot{x}^j}_i}{\LL} \\
-\PD{{x^j}_i}{\phi_{21}} &= m_i {\ddot{x}^j}_i
\end{align*}

Evaluating the potential derivatives separately.  Consider the $i=2$ derivative

\begin{align*}
\PD{{x^j}_2}{\phi_{21}}
&=
\kappa \PD{{x^j}_2}{} \left( \sum_k ({x^k}_2 - {x^k}_1)^2 \right)^{-1/2} \\
&=
-\kappa \inv{\Abs{\Br_2 - \Br_1}^3} \sum_k ({x^k}_2 - {x^k}_1) \PD{{x^j}_2}{} ({x^k}_2 - {x^k}_1) \\
&=
-\kappa \inv{\Abs{\Br_2 - \Br_1}^3} ({x^j}_2 - {x^j}_1)
\end{align*}

%Somewhat problematic in this derivative is the fact that the derivative of an absolute or square is multivalued.  Consider the graph of $y = (x-a)^2$, the derivative is $y' = \pm 2 (x-a)$ depending upon which side of the parabola one is evaluating the slope.  It appears that everything will work out, obtaining the Newtonian gravitation equations for two particle interaction with either sign, but we have to use the same sign for all derivatives.  With this sign picked arbitrarily following the sense convention of this above calculation, we have from the Euler-Lagrange equations

Therefore the final result of the Euler-Lagrange equations is

\begin{align}\label{eqn:hamiltonian:moo4}
\kappa \inv{\Abs{\Br_2 - \Br_1}^3} ({x^j}_2 - {x^j}_1) &= m_2 {\ddot{x}^j}_2 \\
-\kappa \inv{\Abs{\Br_2 - \Br_1}^3} ({x^j}_2 - {x^j}_1) &= m_1 {\ddot{x}^j}_1
\end{align}

which confirms the Lagrangian and potential guess and fixes the constant $\kappa = - G m_1 m_2$.  With the sign fixed, our potential, Lagrangian, and Hamiltonian are respectively

\begin{align}\label{eqn:hamiltonian:moo5}
\phi_{21} &= -\frac{G m_2 m_1 }{\Abs{\Br_2 - \Br_1}}  \\
\LL &= \inv{2} m_1 {\Bv_1}^2 +\inv{2} m_2 {\Bv_2}^2 - \phi_{21} \\
H &= \inv{2 m_1} {\Bp_1}^2 +\inv{2 m_2} {\Bp_2}^2 + \phi_{21}
\end{align}

There is however an undesirable asymmetry to this expression, in particular a formulation that extends to multiple particles seems desirable.  Let us write instead a slight variation

\begin{align}\label{eqn:hamiltonian:moo6}
\phi_{ij} = - \frac{G m_i m_j}{\Abs{\Br_i - \Br_j}}
\end{align}

and form a scaled by two double summation over all pairs of potentials

\begin{align}\label{eqn:hamiltonian:moo7}
\LL &= \sum_i \inv{2} m_i {\Bv_i}^2 - \inv{2} \sum_{i \ne j} \phi_{ij}
\end{align}

%Again since $$, for this to have meaning an agreement to evaluate the Euler-Lagrange partials according to the following ``positive'' sense is required
%
%\begin{align}\label{eqn:hamiltonian:moo8}
%\PD{{x^j}_i}{} (\Br_a - \Br_b)^2 \equiv (\Br_a - \Br_b) \cdot \PD{{x^j}_i}{} (\Br_a - \Br_b)
%\end{align}

Having established what seems like an appropriate form for the Lagrangian, we can write the Hamiltonian for the multiparticle gravitational interaction by inspection

\begin{align}\label{eqn:hamiltonian:moo9}
H = \sum_i \inv{2 m_i} {\Bp_i}^2 + \inv{2} \sum_{i \ne j} \phi_{ij}
\end{align}

This leaves us finally in position to evaluate the Hamiltonian equations, but the result of doing so is rudely nothing more than the Newtonian equations in coordinate form.  We get, for the $k$th component of the $i$th particle

\begin{align}\label{eqn:hamiltonian:moo10}
\PD{{p^k}_i}{H} = {\dot{x}^k}_i = \inv{m_i} {p^k}_i
\end{align}

\begin{align}\label{eqn:hamiltonian:moo11}
\PD{{x^k}_i}{H} = -{\dot{p}^k}_i = G \sum_{j \ne i} m_i m_j \frac{{x^k}_i -{x^k}_j}{\Abs{\Br_i - \Br_j}^3}
\end{align}

The state space vector for this system of equations is brutally ugly, and could be put into the following form for example

\begin{align}\label{eqn:hamiltonian:moo12}
\Bz =
\begin{bmatrix}
{p^1}_1 \\
{p^2}_1 \\
{p^3}_1 \\
{x^1}_1 \\
{x^2}_1 \\
{x^3}_1 \\
{p^1}_2 \\
{p^2}_2 \\
{p^3}_2 \\
{x^1}_2 \\
\vdots \\
\end{bmatrix}
\end{align}

Where the Hamiltonian equations take the form of a non-linear function on such state space vectors
We have a somewhat sparse equation of the form

\begin{align}\label{eqn:hamiltonian:moo13}
\frac{d\Bz}{dt} = A(\Bz)
\end{align}

One thing that is possible in such a representation is calculating the first order approximate change in position and momentum moving from one time to a small time later

\begin{align}\label{eqn:hamiltonian:moo14}
\Bz(t_0 + \Delta t) = \Bz(t_0) + A(\Bz(t_0)) \Delta t
\end{align}

One could conceivably calculate the trajectories in phase space using such increments, and if a small enough time increment is used this can be thought of as solving the gravitational system.  I recall that Feynman did something like this in his lectures, but set up the problem in a more computationally efficient form (it definitely did not have the redundancy built into the Hamiltonian equations).

FIXME: should be able to solve this for an arbitrary $\Delta t$ later time if this was extended to the higher order terms.  Need something like the $e^{z \cdot \grad}$ chain rule expansion.  Think this through.  Will be a little different since we are already starting with the first order contribution.

What does this system of equations look like with a reduction of order through center of mass change of variables?
% Lut was exploring this and having trouble.

\subsection{Pendulum}

FIXME: picture.  x-axis down, y-axis right.

%For the position of the pendulum bob, lets write
%
%\begin{align}\label{eqn:hamiltonian:yoo1}
%\Bx &= r \xcap e^{i \theta} \\
%%\Bv &= \xcap ( \rdot + r i \thetadot ) e^{i \theta} \\
%i &= \xcap \ycap
%\end{align}

The bob speed for a stiff rod of length $l$ is $(l \thetadot)^2$, and our potential is $m g h = m g l (1 -\cos\theta)$.  The Lagrangian is therefore

\begin{align}\label{eqn:hamiltonian:yoo2}
\LL = \inv{2} m l^2 \thetadot^2 - mg l (1 -\cos\theta) \\
\end{align}

The constant $m g l$ term can be dropped, and our canonical momentum conjugate to $\thetadot$ is $p_\theta = m l^2 \thetadot$, so our Hamiltonian is

\begin{align}\label{eqn:hamiltonian:yoo3}
H = \inv{2 m l^2} {p_\theta}^2 - mg l \cos\theta \\
\end{align}

We can now compute the Hamiltonian equations

\begin{align}\label{eqn:hamiltonian:yoo4}
\PD{p_\theta}{H}  &= \thetadot         = \inv{ m l^2 } p_\theta \\
\PD{q}{H}         &= -\dot{p}_\theta   = m g l \sin\theta
\end{align}

Only in the neighborhood of a particular angle can we write this in matrix form.  Suppose we expand this around $\theta = \theta_0 + \alpha$.  The sine is then

\begin{align}\label{eqn:hamiltonian:yoo5}
\sin\theta \approx \sin\theta_0 + \cos\theta_0 \alpha
\end{align}

The linear approximation of the Hamiltonian equations after a change of variables become

\begin{align}\label{eqn:hamiltonian:yoo6}
\frac{d}{dt}
\begin{bmatrix}
p_\theta \\
\alpha
\end{bmatrix}
=
\begin{bmatrix}
0 & -m g l \cos\theta_0 \\
1/ m l^2 & 0
\end{bmatrix}
\begin{bmatrix}
p_\theta \\
\alpha
\end{bmatrix}
+
\begin{bmatrix}
-
m g l \sin\theta_0 \\
\dot{\theta}_0
\end{bmatrix}
\end{align}

A change of variables that scales the factors in the matrix to have equal magnitude and equivalent dimensions is helpful.  Writing

\begin{align}\label{eqn:hamiltonian:yoo7}
\begin{bmatrix}
p_\theta \\
\alpha
\end{bmatrix}
=
\begin{bmatrix}
a & 0 \\
0 & 1
\end{bmatrix}
\Bz
\end{align}

one finds

\begin{align}\label{eqn:hamiltonian:yoo8a}
\frac{d\Bz}{dt}
%&=
%\begin{bmatrix}
%1/a & 0 \\
%0 & 1
%\end{bmatrix}
%\begin{bmatrix}
%0 & -m g l \cos\theta_0 \\
%1/ m l^2 & 0
%\end{bmatrix}
%\begin{bmatrix}
%a & 0 \\
%0 & 1
%\end{bmatrix}
%\Bz
%-
%\frac{m g l \sin\theta_0 }{a}
%\begin{bmatrix}
%1 \\
%0
%\end{bmatrix} \\
%&=
%\begin{bmatrix}
%0 & -m g l \cos\theta_0/a \\
%1/ m l^2 & 0
%\end{bmatrix}
%\begin{bmatrix}
%a & 0 \\
%0 & 1
%\end{bmatrix}
%\Bz
%-
%\frac{m g l \sin\theta_0 }{a}
%\begin{bmatrix}
%1 \\
%0
%\end{bmatrix} \\
&=
\begin{bmatrix}
0 & -m g l \cos\theta_0/a \\
a/ m l^2 & 0
\end{bmatrix}
\Bz
+
\inv{a}
\begin{bmatrix}
- m g l \sin\theta_0 \\
\dot{\theta}_0
\end{bmatrix}
\end{align}

To tidy this up, we want

\begin{align}\label{eqn:hamiltonian:yoo9}
\Abs{\frac{a}{m l^2}} = \Abs{\frac{m g l \cos\theta_0}{a}}
%a^2 = m^2 l^4 \frac{g}{l} \cos\theta_0
\end{align}

Or
\begin{align}\label{eqn:hamiltonian:yoo9b}
a = m l^2 \sqrt{\frac{g}{l} \Abs{\cos\theta_0}}
\end{align}

The result of applying this scaling is quite different above and below the horizontal due to the sign difference in the cosine.  Below the horizontal where $\theta_0 \in (-\pi/2, \pi/2)$ we get

\begin{align}\label{eqn:hamiltonian:yoo11}
\frac{d\Bz}{dt}
&=
\sqrt{\frac{g}{l} \cos\theta_0}
\begin{bmatrix}
0 & -1 \\
1 & 0
\end{bmatrix}
\Bz
+ \inv{m l^2 \sqrt{\frac{g}{l} \cos\theta_0}}
\begin{bmatrix}
- m g l \sin\theta_0 \\
\dot{\theta}_0
\end{bmatrix}
\end{align}

and above the horizontal where $\theta_0 \in (\pi/2, 3\pi/2)$ we get

\begin{align}\label{eqn:hamiltonian:yoo12}
\frac{d\Bz}{dt}
&=
\sqrt{-\frac{g}{l} \cos\theta_0}
\begin{bmatrix}
0 & 1 \\
1 & 0
\end{bmatrix}
\Bz
+ \inv{m l^2 \sqrt{-\frac{g}{l} \cos\theta_0}}
\begin{bmatrix}
- m g l \sin\theta_0 \\
\dot{\theta}_0
\end{bmatrix}
\end{align}

Since $\Bigl(\begin{smallmatrix} 0 & -1 \\ 1 & 0 \end{smallmatrix}\Bigl)$ has the characteristics of an imaginary number (squaring to the negative of the identity) the homogeneous part of the solution for the change of the phase space vector in the vicinity of any initial angle in the lower half plane is trigonometric.  Similarly the solutions are necessarily hyperbolic in the upper half plane since $\Bigl(\begin{smallmatrix} 0 & 1 \\ 1 & 0 \end{smallmatrix}\Bigl)$ squares to identity.  And around $\pm \pi/2$ something totally different (return to this later).  The problem is now reduced to solving a non-homogeneous first order matrix equation of the form

\begin{align}\label{eqn:hamiltonian:yoo13}
\Bz' = \Omega \Bz + \Bb
\end{align}

But we have the good fortune of being able to easily exponentiate and invert this matrix $\Omega$.  The homogeneous problem

\begin{align}\label{eqn:hamiltonian:yoo13h}
\Bz' = \Omega \Bz
\end{align}

has the solution

\begin{align}\label{eqn:hamiltonian:yoo14}
\Bz_h(t) = e^{\Omega t} \Bz_{t=0}
\end{align}

Assuming a specific solution $z = e^{\Omega t}f(t)$ for the non-homogeneous equation, one finds $z = \Omega^{-1} (e^{\Omega t} - I) \Bb$.  The complete solution with both the homogeneous and non-homogeneous parts is thus

\begin{align}\label{eqn:hamiltonian:yoo15}
\Bz(t) = e^{\Omega t} \Bz_0 + \Omega^{-1} (e^{\Omega t} - I) \Bb
\end{align}

Going back to the pendulum problem, lets write

\begin{align}\label{eqn:hamiltonian:yoo12o}
\omega = \sqrt{\frac{g}{l} \abs{\cos\theta_0}}
\end{align}

Below the horizontal we have

\begin{align}\label{eqn:hamiltonian:yoo16}
\Omega
&= \omega
\begin{bmatrix}
0 & -1 \\
1 & 0
\end{bmatrix} \\
\Omega^{-1}
&= -\inv{\omega} \begin{bmatrix}
0 & -1 \\
1 & 0
\end{bmatrix} \\
e^{\Omega t}
&=
\cos(\omega t)
\begin{bmatrix}
1 & 0 \\
0 & 1
\end{bmatrix}
+\sin(\omega t)
\begin{bmatrix}
0 & -1 \\
1 & 0
\end{bmatrix}
\end{align}

Whereas above the horizontal we have

\begin{align}\label{eqn:hamiltonian:yoo17}
\Omega
&= \omega
\begin{bmatrix}
0 & 1 \\
1 & 0
\end{bmatrix} \\
\Omega^{-1}
&= \inv{\omega} \begin{bmatrix}
0 & 1 \\
1 & 0
\end{bmatrix} \\
e^{\Omega t}
&=
\cosh(\omega t)
\begin{bmatrix}
1 & 0 \\
0 & 1
\end{bmatrix}
+\sinh(\omega t)
\begin{bmatrix}
0 & 1 \\
1 & 0
\end{bmatrix}
\end{align}

In both cases we have
\begin{align}\label{eqn:hamiltonian:yoo18}
\begin{bmatrix}
p_\theta \\
\alpha
\end{bmatrix}
&=
\begin{bmatrix}
m l^2 \omega & 0 \\
0 & 1
\end{bmatrix}
\Bz \\
\Bb &= 
\inv{\omega}
\begin{bmatrix}
- \frac{g}{l} \sin\theta_0 \\
\frac{\dot{\theta}_0}{m l^2}
\end{bmatrix}
\end{align}

(where the real angle was $\theta = \theta_0 + \alpha$).  Since in this case $\Omega^{-1}$ and $e^{\Omega t}$ commute, we have below the horizontal

\begin{align*}
\Bz(t)
&= e^{\Omega t} (\Bz_0 - \Omega^{-1} \Bb) - \Omega^{-1} \Bb \\
&=
\left(
\cos(\omega t)
\begin{bmatrix}
1 & 0 \\
0 & 1
\end{bmatrix}
+\sin(\omega t)
\begin{bmatrix}
0 & -1 \\
1 & 0
\end{bmatrix}
\right)
\left(\Bz_0 +\inv{\omega} \begin{bmatrix}
0 & -1 \\
1 & 0
\end{bmatrix}
\Bb \right)
+\inv{\omega} \begin{bmatrix}
0 & -1 \\
1 & 0
\end{bmatrix}
\Bb
\end{align*}

Expanding out the $\Bb$ terms and doing the same for above the horizontal we have respectively (below and above)

\begin{align}\label{eqn:hamiltonian:yoo21}
\Bz_{\text{low}}(t)
&=
\left(
\cos(\omega t)
\begin{bmatrix}
1 & 0 \\
0 & 1
\end{bmatrix}
+\sin(\omega t)
\begin{bmatrix}
0 & -1 \\
1 & 0
\end{bmatrix}
\right)
\left(\Bz_0
-\inv{\omega^2}
\begin{bmatrix}
\frac{\dot{\theta}_0}{m l^2} \\
\frac{g}{l} \sin\theta_0 \\
\end{bmatrix} 
\right)
-\inv{\omega^2}
\begin{bmatrix}
\frac{\dot{\theta}_0}{m l^2} \\
\frac{g}{l} \sin\theta_0 \\
\end{bmatrix} \\
\Bz_{\text{high}}(t)
&=
\left(
\cosh(\omega t)
\begin{bmatrix}
1 & 0 \\
0 & 1
\end{bmatrix}
+\sinh(\omega t)
\begin{bmatrix}
0 & 1 \\
1 & 0
\end{bmatrix}
\right)
\left(\Bz_0
+\inv{\omega^2}
\begin{bmatrix}
\frac{\dot{\theta}_0}{m l^2} \\
\frac{g}{l} \sin\theta_0 \\
\end{bmatrix} 
\right)
+\inv{\omega^2}
\begin{bmatrix}
\frac{\dot{\theta}_0}{m l^2} \\
\frac{g}{l} \sin\theta_0 \\
\end{bmatrix} 
\end{align}

The only thing that is really left is re-insertion of the original momentum and position variables using the inverse relation

\begin{align}\label{eqn:hamiltonian:yoo20}
\Bz
&=
\begin{bmatrix}
1/(m l^2 \omega) & 0 \\
0 & 1
\end{bmatrix}
\begin{bmatrix}
p_\theta \\
\theta - \theta_0
\end{bmatrix}
\end{align}

Will that final insertion do anything more than make things messier?  Observe that the $\Bz_0$ only has a momentum component when expressed back in terms of the total angle $\theta$.  Also recall that $p_\theta = m l^2 \dot{\theta}$, so we have

\begin{align}\label{eqn:hamiltonian:yoo20a}
\Bz
&=
\begin{bmatrix}
\dot{\theta}/\omega \\
\theta - \theta_0
\end{bmatrix} \\
\Bz_0
&=
\begin{bmatrix}
\dot{\theta}_{t=0}/\omega \\
0
\end{bmatrix} \\
\end{align}

If this is somehow mystically free of all math mistakes then we have the final solution

\begin{align}\label{eqn:hamiltonian:yoo19}
{\begin{bmatrix}
\dot{\theta}(t)/\omega \\
\theta(t) - \theta_0
\end{bmatrix}}_{\text{low}}
&=
\left(
\cos(\omega t)
\begin{bmatrix}
1 & 0 \\
0 & 1
\end{bmatrix}
+\sin(\omega t)
\begin{bmatrix}
0 & -1 \\
1 & 0
\end{bmatrix}
\right)
\left(
\frac{\dot{\theta}(0)}{\omega}
\begin{bmatrix}
1 \\
0
\end{bmatrix}
%\Bz_0
-\inv{\omega^2}
\begin{bmatrix}
\frac{\dot{\theta}_0}{m l^2} \\
\frac{g}{l} \sin\theta_0 \\
\end{bmatrix}
\right)
-\inv{\omega^2}
\begin{bmatrix}
\frac{\dot{\theta}_0}{m l^2} \\
\frac{g}{l} \sin\theta_0 \\
\end{bmatrix}
\\
{\begin{bmatrix}
\dot{\theta}(t)/\omega \\
\theta(t) - \theta_0
\end{bmatrix}}_{\text{high}}
&=
\left(
\cosh(\omega t)
\begin{bmatrix}
1 & 0 \\
0 & 1
\end{bmatrix}
+\sinh(\omega t)
\begin{bmatrix}
0 & 1 \\
1 & 0
\end{bmatrix}
\right)
\left(
%\Bz_0
\frac{\dot{\theta}(0)}{\omega}
\begin{bmatrix}
1 \\
0
\end{bmatrix}
+\inv{\omega^2}
\begin{bmatrix}
\frac{\dot{\theta}_0}{m l^2} \\
\frac{g}{l} \sin\theta_0 \\
\end{bmatrix}
\right)
+\inv{\omega^2}
\begin{bmatrix}
\frac{\dot{\theta}_0}{m l^2} \\
\frac{g}{l} \sin\theta_0 \\
\end{bmatrix}
\end{align}

A qualification is required to call this a solution since it is only a solution is the restricted range where $\theta$ is close enough to $\theta_0$ (in some imprecisely specified sense).  One could conceivably apply this in a recursive fashion however, calculating the result for a small incremental change, yielding the new phase space point, and repeating at the new angle.

The question of what the form of the solution in the neighborhood of $\pm \pi/2$ has also been ignored.  That is probably also worth considering but I do not feel like trying now.

\subsection{Spherical pendulum}

For the spherical rigid pendulum of length $l$, we have for the distance above the lowest point

\begin{align}\label{eqn:hamiltonian:uoo1}
h = l (1 + \cos\theta)
\end{align}

(measuring $\theta$ down from the North pole as conventional).  The Lagrangian is therefore

\begin{align}\label{eqn:hamiltonian:uoo2}
\LL = \inv{2} m l^2 (\thetadot^2 + \sin^2\theta \phidot^2) - m g l (1 + \cos\theta)
\end{align}

We can drop the constant term, using the simpler Lagrangian

\begin{align}\label{eqn:hamiltonian:uoo3}
\LL = \inv{2} m l^2 (\thetadot^2 + \sin^2\theta \phidot^2) - m g l \cos\theta
\end{align}

To express the Hamiltonian we need first the conjugate momenta, which are

\begin{align}\label{eqn:hamiltonian:uoo4}
P_\theta &= \PD{\thetadot}{\LL} = m l^2 \thetadot \\
P_\phi &= \PD{\phidot}{\LL} = m l^2 \sin^2\theta \phidot
\end{align}

We can now write the Hamiltonian

\begin{align}\label{eqn:hamiltonian:uoo5}
H = \inv{2 m l^2} \left({P_\theta}^2 + \inv{\sin^2\theta} {P_\phi}^2\right) + m g l \cos\theta
\end{align}

Before going further one sees that there is going to be trouble where $\sin\theta = 0$.  Curiously, this is at the poles, the most dangling position and the upright.  The south pole is the usual point where we solve the planar pendulum problem using the harmonic oscillator approximation, so it is somewhat curious that the energy of the system appears to go undefined at this point where the position is becoming more defined.  It seems almost like a quantum uncertainty phenomena until one realizes that the momentum conjugate to $\phi$ is itself proportional to $\sin^2 \theta$.  By expressing the energy in terms of this $P_\phi$ momentum we have to avoid looking at the poles for a solution to the equations.  If we go back to the Lagrangian and the Euler-Lagrange equations, this point becomes perfectly tractable since we are no longer dividing through by $\sin^2\theta$.

Examining the polar solutions is something to return to.  For now, let us avoid that region.  For regions where $\sin\theta$ is nicely non-zero, we get for the Hamiltonian equations

\begin{align}\label{eqn:hamiltonian:uoo6}
\PD{P_\phi}{H} &= \dot{\phi} = \inv{ m l^2 \sin^2 \theta} P_\phi \\
\PD{P_\theta}{H} &= \dot{\theta} = \inv{ m l^2 } P_\theta \\
\PD{\phi}{H} &= -\dot{P}_\phi = 0 \\
\PD{\theta}{H} &= -\dot{P}_\theta = -\frac{\cos\theta}{ m l^2 \sin^3 \theta} {P_\phi}^2 - m g l \sin\theta
\end{align}

These now expressing the dynamics of the system.  The first two equations are just the definitions of the canonical momenta that we started with using the Lagrangian.  Not surprisingly, but unfortunate, we have a non-linear system here like the planar rigid pendulum, so despite this being one of the most simple systems it does not look terribly tractable.  What would it take to linearize this system of equations?

Lets write the state space vector for the system as

\begin{align}\label{eqn:hamiltonian:uoo7}
\Bx =
\begin{bmatrix}
P_\theta \\
\theta \\
P_\phi \\
\phi \\
\end{bmatrix}
\end{align}

lets also suppose that we are interested in the change to the state vector in the neighborhood of an initial state

\begin{align}\label{eqn:hamiltonian:uoo8}
\Bx =
\begin{bmatrix}
P_\theta \\
\theta \\
P_\phi \\
\phi \\
\end{bmatrix}
=
{
\begin{bmatrix}
P_\theta \\
\theta \\
P_\phi \\
\phi \\
\end{bmatrix}
}_0
+
\Bz
\end{align}

The Hamiltonian equations can then be written

\begin{align}\label{eqn:hamiltonian:uoo9}
\frac{d\Bz}{dt} &=
\begin{bmatrix}
\frac{\cos\theta}{ m l^2 \sin^3 \theta} {P_\phi}^2 + m g l \sin\theta \\
\inv{ m l^2 } P_\theta \\
0 \\
\inv{ m l^2 \sin^2 \theta} P_\phi \\
\end{bmatrix}
\end{align}

Getting away from the specifics of this particular system is temporarily helpful.  We have a set of equations that we wish to calculate a linear approximation for

\begin{align}\label{eqn:hamiltonian:uoo10}
\frac{dz_\mu}{dt} = A_\mu(x_\nu) \approx A_\mu(\Bx_0) + \sum_\alpha {\left. \PD{x_\alpha}{A_\mu} \right\vert}_{\Bx_0} z_\alpha
\end{align}

Our linear approximation is thus

\begin{align}\label{eqn:hamiltonian:uoo11}
\frac{d\Bz}{dt} &\approx
{
\begin{bmatrix}
\frac{\cos\theta}{ m l^2 \sin^3 \theta} {P_\phi}^2 + m g l \sin\theta \\
\inv{ m l^2 } P_\theta \\
0 \\
\inv{ m l^2 \sin^2 \theta} P_\phi \\
\end{bmatrix}
}_0
+
%{
%\begin{bmatrix}
%0 & \PD{\theta}{}\left( \frac{\cos\theta}{ m l^2 \sin^3 \theta} {P_\phi}^2 + m g l \sin\theta \right) & \frac{2 \cos\theta}{ m l^2 \sin^3 \theta} P_\phi & 0 \\
%1/m l^2 & 0 & 0 & 0 \\
%0 & 0 & 0 & 0 \\
%0 & \frac{P_\phi}{m l^2} \PD{\theta}{\inv{\sin^2\theta}} & \inv{ m l^2 \sin^2 \theta} & 0 \\
%\end{bmatrix}
%}_0
{
\begin{bmatrix}
0 &
-\frac{{P_\phi}^2 (1 + 2 \cos^2 \theta)}{m l^2 \sin^4 \theta} +m g l \cos\theta
& \frac{2 \cos\theta}{ m l^2 \sin^3 \theta} P_\phi & 0 \\
\inv{m l^2} & 0 & 0 & 0 \\
0 & 0 & 0 & 0 \\
0 & \frac{-2 P_\phi \cos\theta}{m l^2 \sin^3\theta} & \inv{ m l^2 \sin^2 \theta} & 0 \\
\end{bmatrix}
}_0
\Bz
\end{align}
%- 1/S^2 + C (-3) S^2 C/ S^6
%=
%- (1/S^2 + 3 C^2 / S^4 )
%=
%- 1/S^4( S^2 + 3 C^2 )
%=
%- 1/S^4( S^2 + 3 (1-S^2)) = - 1/S^4( 3 - 2 S^2 )
% or:
%=
%- 1/S^4( 1 - C^2 + 3 C^2 )
%=
%- 1/S^4( 1 + 2 C^2 )

Now, this is what we get blindly trying to set up the linear approximation of the state space differential equation.  We see that the cyclic coordinate $\phi$ leads to a bit of trouble since no explicit $\phi$ dependence in the Hamiltonian makes the resulting matrix factor non-invertible.  It appears that we would be better explicitly utilizing this cyclic coordinate to note that $P_\phi = \text{constant}$, and to omit this completely from the state vector.  Our equations in raw form are now

\begin{align}\label{eqn:hamiltonian:uoo12}
\dot{\theta} &= \inv{ m l^2 } P_\theta \\
\dot{P}_\theta &= \frac{\cos\theta}{ m l^2 \sin^3 \theta} {P_\phi}^2 + m g l \sin\theta \\
\dot{\phi} &= \inv{ m l^2 \sin^2 \theta} P_\phi
\end{align}

We can treat the $\phi$ dependence later once we have solved for $\theta$.  That equation to later solve is just this last

\begin{align}\label{eqn:hamiltonian:uoo13}
\dot{\phi} &= \inv{ m l^2 \sin^2 \theta} P_\phi
\end{align}

This integrates directly, presuming $\theta = \theta(t)$ is known, and we have

\begin{align}\label{eqn:hamiltonian:uoo13b}
\phi - \phi(0) &= \frac{P_\phi}{ m l^2} \int_0^t \frac{d\tau}{\sin^2 \theta(\tau)}
\end{align}

Now the state vector and its perturbation can be redefined omitting all but the $\theta$ dependence.  Namely

\begin{align}\label{eqn:hamiltonian:uoo7p}
\Bx =
\begin{bmatrix}
P_\theta \\
\theta \\
\end{bmatrix}
\end{align}

\begin{align}\label{eqn:hamiltonian:uoo8p}
\Bx =
\begin{bmatrix}
P_\theta \\
\theta \\
\end{bmatrix}
=
{
\begin{bmatrix}
P_\theta \\
\theta \\
\end{bmatrix}
}_0
+
\Bz
\end{align}

We can now write the remainder of this non-linear system as
\begin{align}\label{eqn:hamiltonian:uoo9p}
\frac{d\Bz}{dt} &=
\begin{bmatrix}
\frac{\cos\theta}{ m l^2 \sin^3 \theta} {P_\phi}^2 + m g l \sin\theta \\
\inv{ m l^2 } P_\theta \\
\end{bmatrix}
\end{align}

and make the linear approximation around $\Bx_0$ as

\begin{align}\label{eqn:hamiltonian:uoo11p}
\frac{d\Bz}{dt} &\approx
{
\begin{bmatrix}
\frac{\cos\theta}{ m l^2 \sin^3 \theta} {P_\phi}^2 + m g l \sin\theta \\
\inv{ m l^2 } P_\theta \\
\end{bmatrix}
}_0
+
{
\begin{bmatrix}
0 & -\frac{{P_\phi}^2 (1 + 2 \cos^2 \theta)}{m l^2 \sin^4 \theta} +m g l \cos\theta  \\
\inv{m l^2} & 0 \\
\end{bmatrix}
}_0
\Bz
\end{align}

This now looks a lot more tractable, and is in fact exactly the same form now as the equation for the linearized planar pendulum.  The only difference is the normalization required to switch to less messy dimensionless variables.  The main effect of allowing the trajectory to have a non-planar component is a change in the angular frequency in the $\theta$ dependent motion.  That frequency will no longer be $\sqrt{\Abs{\cos\theta_0} g/l}$, but also has a $P_\phi$ and other more complex trigonometric $\theta$ dependencies.  It also appears that we can probably have hyperbolic or trigonometric solutions in the neighborhood of any point, regardless of whether it is a northern hemispherical point or a southern one.  In the planar pendulum the unambiguous sign of the matrix terms led to hyperbolic only above the horizon, and trigonometric only below.

\subsection{Double and multiple pendulums, and general quadratic velocity dependence}

In the following section I started off with the goal of treating two connected pendulums moving in a plane.  Even setting up the Hamiltonian's for this turned out to be a bit messy, requiring a matrix inversion.  Tackling the problem in the guise of using a more general quadratic form (which works for the two particle as well as $N$ particle cases) seemed like it would actually be simpler than using the specifics from the angular velocity dependence of the specific pendulum problem.  Once the Hamiltonian equations were found in this form, an attempt to do the first order Taylor expansion as done for the single planar pendulum and the spherical pendulum was performed.  This turned out to be a nasty mess and is seen to not be particularly illuminating.  I did not know that is how it would turn out ahead of time since I had my fingers crossed for some sort of magic simplification once the final substitution were made.  If such a simplification is possible, the procedure to do so is not obvious.

Although the Hamiltonian equations for a spherical pendulum have been considered previously, for the double pendulum case it seems prudent to avoid temptation, and to first see what happens with a simpler first step, a planar double pendulum.

Setting up coordinates $x$ axis down, and $y$ axis to the left with $i = \xcap \ycap$ we have for the position of the first mass $m_1$, at angle ${\theta_1}$ and length $l_1$

\begin{align}\label{eqn:hamiltonian:voo1}
z_1 = \xcap l_1 e^{i{\theta_1}}
\end{align}

If the second mass, dangling from this is at an angle ${\theta_2}$ from the $x$ axis, its position is

\begin{align}\label{eqn:hamiltonian:voo2}
z_2 = z_1 + \xcap l_2 e^{i{\theta_2}}
\end{align}

We need the velocities, and their magnitudes.  For $z_1$ this is

\begin{align}\label{eqn:hamiltonian:voo3}
\Abs{\dot{z}_1}^2 = {l_1}^2 {\dot{\theta}_1}^2
\end{align}

For the second mass

\begin{align}\label{eqn:hamiltonian:voo4}
\dot{z}_2 = \xcap i \left( l_1 {\dot{\theta}_1} e^{i{\theta_1}} + l_2 {\dot{\theta}_2} e^{i{\theta_2}} \right)
\end{align}

Taking conjugates and multiplying out we have

\begin{align}\label{eqn:hamiltonian:voo5}
\Abs{\dot{z}_2}^2 =
{l_1}^2 {\dot{\theta}_1}^2
+ 2 l_1 l_2 {\dot{\theta}_1} {\dot{\theta}_2} \cos({\theta_1} - {\theta_2})
+{l_2}^2 {\dot{\theta}_2}^2
\end{align}

That is all that we need for the Kinetic terms in the Lagrangian.  Now we need the height for the $m g h$ terms.  If we set the reference point at the lowest point for the double pendulum system, the height of the first particle is

\begin{align}\label{eqn:hamiltonian:voo6}
h_1 = l_2 + l_1 (1 -\cos{\theta_1})
\end{align}

For the second particle, the distance from the horizontal is
\begin{align}\label{eqn:hamiltonian:voo7}
d = l_1 \cos{\theta_1} + l_2 \cos{\theta_2}
\end{align}

So the total distance from the reference point is
\begin{align}\label{eqn:hamiltonian:voo8}
h_2 = l_1 (1 - \cos{\theta_1}) + l_2 (1 -\cos{\theta_2})
\end{align}

We now have the Lagrangian
\begin{align}\label{eqn:hamiltonian:voo9}
\LL' &=
\inv{2} m_1 {l_1}^2 {\dot{\theta}_1}^2
+ \inv{2} m_2 \left(
{l_1}^2 {\dot{\theta}_1}^2
+ 2 l_1 l_2 {\dot{\theta}_1} {\dot{\theta}_2} \cos({\theta_1} - {\theta_2})
+{l_2}^2 {\dot{\theta}_2}^2
\right) \\
&-
m_1 g (l_2 + l_1 (1 -\cos{\theta_1}))
-
m_2 g ( l_1 (1 - \cos{\theta_1}) + l_2 (1 -\cos{\theta_2}) )
\end{align}

Dropping constant terms (effectively choosing a difference reference point for the potential) and rearranging a bit, also writing $M = m_1 + m_2$, we have the simpler Lagrangian

\begin{align}\label{eqn:hamiltonian:voo10}
\LL &=
\inv{2} M {l_1}^2 {\dot{\theta}_1}^2 + \inv{2} m_2 {l_2}^2 {\dot{\theta}_2}^2
+ m_2 l_1 l_2 {\dot{\theta}_1} {\dot{\theta}_2} \cos({\theta_1} - {\theta_2})
+
M l_1 g \cos{\theta_1}
+
m_2 l_2 g \cos{\theta_2}
\end{align}

The conjugate momenta that we need for the Hamiltonian are

\begin{align}\label{eqn:hamiltonian:voo11}
P_{\theta_1} &=
M {l_1}^2 {\dot{\theta}_1}
+ m_2 l_1 l_2 {\dot{\theta}_2} \cos({\theta_1} - {\theta_2}) \\
P_{\theta_2} &=
m_2 {l_2}^2 {\dot{\theta}_2}
+ m_2 l_1 l_2 {\dot{\theta}_1} \cos({\theta_1} - {\theta_2})
\end{align}

Unlike any of the other simpler Hamiltonian systems considered so far, the coupling between the velocities means that we have a system of equations that we must first invert before we can even express the Hamiltonian in terms of the respective momenta.

That is
\begin{align}\label{eqn:hamiltonian:voo12}
\begin{bmatrix}
P_{\theta_1} \\
P_{\theta_2}
\end{bmatrix}
=
\begin{bmatrix}
M {l_1}^2 & m_2 l_1 l_2 \cos({\theta_1} - {\theta_2}) \\
m_2 l_1 l_2 \cos({\theta_1} - {\theta_2}) & m_2 {l_2}^2
\end{bmatrix}
\begin{bmatrix}
{\dot{\theta}_1} \\
{\dot{\theta}_2}
\end{bmatrix}
\end{align}

While this is easily invertible, doing so and attempting to substitute it back, results in an unholy mess (albeit perhaps one that can be simplified).  Is there a better way?  A possibly promising way is motivated by observing that this matrix, a function of the angular difference $\delta = {\theta_1} - {\theta_2}$, looks like it is something like a moment of inertia tensor.  If we call this $\mathcal{I}$, and write

\begin{align}\label{eqn:hamiltonian:voo13}
\BTheta
&\equiv
\begin{bmatrix}
{\theta_1} \\
{\theta_2}
\end{bmatrix}
\end{align}

Then the relation between the conjugate momenta in vector form

\begin{align}\label{eqn:hamiltonian:voo14}
\Bp &\equiv
\begin{bmatrix}
P_{\theta_1} \\
P_{\theta_2}
\end{bmatrix}
\end{align}

and the angular velocity vector can be written

\begin{align}\label{eqn:hamiltonian:voo15}
\Bp &= \mathcal{I}(\delta)
\dot{\BTheta}
\end{align}

Can we write the Lagrangian in terms of $\dot{\BTheta}$?  The first Kinetic term is easy, just

\begin{align}\label{eqn:hamiltonian:voo16}
\inv{2} m_1 l^2 {\dot{\theta}_1}^2 = \inv{2} m_1
\dot{\BTheta}^\T
\begin{bmatrix}
l_1^2 & 0 \\
0 & 0
\end{bmatrix}
\dot{\BTheta}
\end{align}

For the second mass, going back to \eqnref{eqn:hamiltonian:voo4}, we can write

\begin{align}\label{eqn:hamiltonian:voo4m}
\dot{z}_2 = \xcap i
\begin{bmatrix}
l_1 e^{i{\theta_1}} & l_2 e^{i{\theta_2}}
\end{bmatrix}
\dot{\BTheta}
\end{align}

Writing $\Br$ for this $1x2$ matrix, we can utilize the associative property for compatible sized matrices to rewrite the speed for the second particle in terms of a quadratic form

\begin{align}\label{eqn:hamiltonian:voo5m}
\Abs{\dot{z}_2}^2
=
(\Br \dot{\BTheta}) (\overbar{\Br} \dot{\BTheta})
=
\dot{\BTheta}^\T (\Br^\T \overbar{\Br}) \dot{\BTheta}
\end{align}

The Lagrangian kinetic can all now be grouped into a single quadratic form

\begin{align}\label{eqn:hamiltonian:voo17}
Q \equiv
m_1
\begin{bmatrix}
l_1 \\
0
\end{bmatrix}
\begin{bmatrix}
l_1 & 0
\end{bmatrix}
+m_2
\begin{bmatrix}
l_1 e^{i{\theta_1}} \\
l_2 e^{i{\theta_2}}
\end{bmatrix}
\begin{bmatrix}
l_1 e^{-i{\theta_1}} & l_2 e^{-i{\theta_2}}
\end{bmatrix}
\end{align}

\begin{align}\label{eqn:hamiltonian:voo18}
\LL =
\inv{2} \dot{\BTheta}^\T Q \dot{\BTheta}
+
M l_1 g \cos{\theta_1}
+
m_2 l_2 g \cos{\theta_2}
\end{align}

It is also clear that this generalize easily to multiple connected pendulums, as follows

\begin{align}\label{eqn:hamiltonian:voo18g}
K &= \inv{2} \dot{\BTheta}^\T \sum_k m_k Q_k \dot{\BTheta} \\
Q_k &=
{\begin{bmatrix}
l_r l_s e^{i(\theta_r - \theta_s)}
\end{bmatrix}}_{r,s \le k} \\
\phi &= - g \sum_k l_k \cos\theta_k \sum_{j=k}^N m_j \\
\LL &= K - \phi
\end{align}

In the expression for $Q_k$ above, it is implied that the matrix is zero for any indices $r,s > k$, so it would perhaps be better to write explicitly

\begin{align}\label{eqn:hamiltonian:voo18q}
Q = \sum_k m_k Q_k
=
{\begin{bmatrix}
\sum_{j=\max(r,s)}^N m_j l_r l_s e^{i(\theta_r - \theta_s)}
\end{bmatrix}}_{r,s}
\end{align}

Returning to the problem, it is convenient and sufficient in many cases to only discuss the representative double pendulum case.  For that we can calculate the conjugate momenta from \eqnref{eqn:hamiltonian:voo18} directly

\begin{align*}
P_{\theta_1}
&=
\PD{{\dot{\theta}_1}}{}
\inv{2} \dot{\BTheta}^\T Q \dot{\BTheta} \\
&=
\PD{{\dot{\theta}_1}}{}
\inv{2} \dot{\BTheta}^\T Q
\begin{bmatrix}
1 \\
0
\end{bmatrix}
+
\inv{2}
\begin{bmatrix}
1 & 0
\end{bmatrix}
Q \dot{\BTheta} \\
&=
\begin{bmatrix}
1 & 0
\end{bmatrix}
\left(\inv{2}(Q + Q^\T)\right) \dot{\BTheta} \\
\end{align*}

Similarly the ${\theta_2}$ conjugate momentum is

\begin{align*}
P_{\theta_2}
=
\begin{bmatrix}
0 & 1
\end{bmatrix}
\left(\inv{2}(Q + Q^\T)\right) \dot{\BTheta} \\
\end{align*}

Putting both together, it is straightforward to verify that this recovers \eqnref{eqn:hamiltonian:voo12}, which can now be written

\begin{align}\label{eqn:hamiltonian:voo19}
\Bp
&=
\inv{2}(Q + Q^\T) \dot{\BTheta} = \mathcal{I} \dot{\BTheta}
\end{align}

Observing that $\mathcal{I} = \mathcal{I}^\T$, and thus $(\mathcal{I}^\T)^{-1} = \mathcal{I}^{-1}$, we now have everything required to express the Hamiltonian in terms of the conjugate momenta

\begin{align}\label{eqn:hamiltonian:voo20}
H = \Bp^\T \left( \inv{2} \mathcal{I}^{-1} Q \mathcal{I}^{-1} \right) \Bp - M g l_1 \cos{\theta_1} - m_2 l_2 g \cos{\theta_2}
\end{align}

This is now in a convenient form to calculate the first set of Hamiltonian equations.

\begin{align*}
\dot{\theta}_k &=
\PD{P_{\theta_k}}{H} \\
&=
\PD{P_{\theta_k}}{\Bp^\T} \inv{2} \mathcal{I}^{-1} Q \mathcal{I}^{-1} \Bp
+ \Bp^\T \inv{2} \mathcal{I}^{-1} Q \mathcal{I}^{-1} \PD{P_{\theta_k}}{\Bp^\T} \\
&=
{\begin{bmatrix}
\delta_{kj}
\end{bmatrix}}_j
\inv{2} \mathcal{I}^{-1} Q \mathcal{I}^{-1} \Bp
+ \Bp^\T \inv{2} \mathcal{I}^{-1} Q \mathcal{I}^{-1}
{\begin{bmatrix}
\delta_{ik}
\end{bmatrix}}_i \\
&=
{\begin{bmatrix}
\delta_{kj}
\end{bmatrix}}_j
\mathcal{I}^{-1} 
\mathLabelBox{\inv{2}(Q + Q^\T)}{$\mathcal{I}$}
\mathcal{I}^{-1} \Bp \\
&=
{\begin{bmatrix}
\delta_{kj}
\end{bmatrix}}_j
\mathcal{I}^{-1} \Bp \\
\end{align*}

So, when the velocity dependence is a quadratic form as identified in \eqnref{eqn:hamiltonian:voo17}, the first half of the Hamiltonian equations in vector form are just

\begin{align}\label{eqn:hamiltonian:voo21}
\dot{\BTheta} &=
{\begin{bmatrix}
\PD{P_{\theta_1}}{} & \cdots & \PD{P_{\theta_N}}{}
\end{bmatrix}}^\T H
=
\mathcal{I}^{-1} \Bp
\end{align}

This is exactly the relation we used in the first place to re-express the Lagrangian in terms of the conjugate momenta in preparation for this calculation.  The remaining Hamiltonian equations are trickier, and what we now want to calculate.  Without specific reference to the pendulum problem, lets do this calculation for the general Hamiltonian for a non-velocity dependent potential.  That is

\begin{align}\label{eqn:hamiltonian:voo22}
H = \Bp^\T \left( \inv{2} \mathcal{I}^{-1} Q \mathcal{I}^{-1} \right) \Bp + \phi(\BTheta)
\end{align}

The remaining Hamiltonian equations are $\PDi{\theta_a}{H} = -\dot{P}_{\theta_a}$, and the tricky part of evaluating this is going to all reside in the Kinetic term.  Diving right in this is

\begin{align*}
\PD{\theta_a}{K} 
&= 
\Bp^\T \left( \inv{2} \PD{\theta_a}{(\mathcal{I}^{-1})} Q \mathcal{I}^{-1} \right) \Bp 
+\Bp^\T \left( \inv{2} \mathcal{I}^{-1} \PD{\theta_a}{Q} \mathcal{I}^{-1} \right) \Bp 
+\Bp^\T \left( \inv{2} \mathcal{I}^{-1} Q \PD{\theta_a}{(\mathcal{I}^{-1})} \right) \Bp \\
&= 
\Bp^\T \PD{\theta_a}{(\mathcal{I}^{-1})} 
\mathLabelBox{\inv{2}(Q + Q^\T)}{$=\mathcal{I}$}
 \mathcal{I}^{-1} \Bp 
+\Bp^\T \left( \inv{2} \mathcal{I}^{-1} \PD{\theta_a}{Q} \mathcal{I}^{-1} \right) \Bp  \\
&= 
\Bp^\T \PD{\theta_a}{(\mathcal{I}^{-1})} \Bp 
+\Bp^\T \left( \inv{2} \mathcal{I}^{-1} \PD{\theta_a}{Q} \mathcal{I}^{-1} \right) \Bp  \\
\end{align*}

For the two particle case we can expand this inverse easily enough, and then take derivatives to evaluate this, but this is messier and intractable for the general case.  We can however, calculate the derivative of the identity matrix using the standard trick from rigid body mechanics

\begin{align*}
0 
&= \PD{\theta_a}{I} \\
&= \PD{\theta_a}{(\mathcal{I} \mathcal{I}^{-1})} \\
&= 
\PD{\theta_a}{\mathcal{I}} \mathcal{I}^{-1}
+\mathcal{I} \PD{\theta_a}{(\mathcal{I}^{-1})} 
\\
\end{align*}

Thus the derivative of the inverse (moment of inertia?) matrix is

\begin{align*}
\PD{\theta_a}{(\mathcal{I}^{-1})} 
&= -\mathcal{I}^{-1}\PD{\theta_a}{\mathcal{I}} \mathcal{I}^{-1} \\
&= -\mathcal{I}^{-1}\inv{2}\left( \PD{\theta_a}{Q} + \PD{\theta_a}{Q^\T} \right) \mathcal{I}^{-1}
\end{align*}

This gives us for the Hamiltonian equation

\begin{align}\label{eqn:hamiltonian:voo24}
\PD{\theta_a}{H} 
%&= 
%-\Bp^\T \mathcal{I}^{-1}\inv{2}\left( \PD{\theta_a}{Q} + \PD{\theta_a}{Q^\T} \right) \mathcal{I}^{-1} \Bp
%+\Bp^\T \left( \inv{2} \mathcal{I}^{-1} \PD{\theta_a}{Q} \mathcal{I}^{-1} \right) \Bp  
%+ \PD{\theta_a}{\phi} \\ 
&= 
-\inv{2} \Bp^\T \mathcal{I}^{-1} \left(\PD{\theta_a}{Q}\right)^\T \mathcal{I}^{-1} \Bp  
+ \PD{\theta_a}{\phi} 
\end{align}

%If we introduce position and momentum gradients in phase space 
If we introduce a phase space position gradients

\begin{align}\label{eqn:hamiltonian:voo25}
%\grad_{\BTheta} &\equiv 
\grad &\equiv 
{\begin{bmatrix}
\PD{\theta_1}{} & \cdots & \PD{\theta_N}{}
\end{bmatrix}}^\T \\
%\grad_{\Bp} &\equiv 
%{\begin{bmatrix}
%\PD{P_{\theta_1}}{} & \cdots & \PD{P_{\theta_N}}{}
%\end{bmatrix}}^\T 
\end{align}

Then for the second half of the Hamiltonian equations we have the vector form

\begin{align}\label{eqn:hamiltonian:voo26}
-\grad H = \dot{\Bp} = 
{\begin{bmatrix}
\inv{2} \Bp^\T \mathcal{I}^{-1} \left(\PD{\theta_r}{Q}\right)^\T \mathcal{I}^{-1} \Bp 
\end{bmatrix}}_r
- \grad \phi
\end{align}

The complete set of Hamiltonian equations for \eqnref{eqn:hamiltonian:voo22}, in block matrix form, describing all the phase space change of the system is therefore

\begin{align}\label{eqn:hamiltonian:veryGeneral}
\frac{d}{dt} 
\begin{bmatrix}
\Bp \\
\BTheta
\end{bmatrix}
=
\begin{bmatrix}
{\begin{bmatrix}
\inv{2} \Bp^\T \mathcal{I}^{-1} \left(\PD{\theta_r}{Q}\right)^\T \mathcal{I}^{-1} \Bp 
\end{bmatrix}}_r
- \grad \phi \\
%\begin{bmatrix}
%\mathcal{I}^{-1} & 0
%\end{bmatrix}
%\begin{bmatrix}
%\Bp \\
%\BTheta
%\end{bmatrix}
\mathcal{I}^{-1} \Bp \\
\end{bmatrix}
=
\begin{bmatrix}
{\begin{bmatrix}
\inv{2} \dot{\BTheta} \left(\PD{\theta_r}{Q}\right)^\T \dot{\BTheta}
\end{bmatrix}}_r
- \grad \phi \\
\dot{\BTheta}
\end{bmatrix}
\end{align}

This is a very general relation, much more so than required for the original two particle problem.  We have the same non-linearity that prevents this from being easily solved.  If we want a linear expansion around a phase space point to find an approximate first order solution, we can get that applying the chain rule, calculating all the $\PDi{\theta_k}{}$, and $\PDi{P_{\theta_k}}{}$ derivatives of the top $N$ rows of this matrix.

If we write 

\begin{align}\label{eqn:hamiltonian:voo28}
\Bz \equiv
\begin{bmatrix}
\Bp \\
\BTheta
\end{bmatrix}
-
\evalnobar{
\begin{bmatrix}
\Bp \\
\BTheta
\end{bmatrix}
}{t=0}
\end{align}

and the Hamiltonian equations \eqnref{eqn:hamiltonian:veryGeneral} as

\begin{align}\label{eqn:hamiltonian:voo27v}
\frac{d}{dt}
\begin{bmatrix}
\Bp \\
\BTheta
\end{bmatrix}
= A(\Bp, \BTheta)
\end{align}

Then the linearization, without simplifying or making explicit yet is

\begin{align}\label{eqn:hamiltonian:voo29}
\dot{\Bz} 
\approx
\evalnobar{
\begin{bmatrix}
{\begin{bmatrix}
\inv{2} \dot{\BTheta} \left(\PD{\theta_r}{Q}\right)^\T \dot{\BTheta}
\end{bmatrix}}_r
- \grad \phi \\
\dot{\BTheta}
\end{bmatrix}
}{t=0}
+
\evalbar{
\begin{bmatrix}
\PD{P_{\theta_1}}{A} & \cdots & \PD{P_{\theta_N}}{A} & \PD{\theta_1}{A} & \cdots & \PD{\theta_N}{A} 
\end{bmatrix}
}{t=0} \Bz
\end{align}

For brevity the constant term evaluated at $t=0$ is expressed in terms of the original angular velocity vector from our Lagrangian.  The task is now evaluating the derivatives in the first order term of this Taylor series.  Let us do these one at a time and then reassemble all the results afterward.

So that we can discuss just the first order terms lets write $\Delta$ for the matrix of first order derivatives in our Taylor expansion, as in

\begin{align}\label{eqn:hamiltonian:voo30p}
f(\Bp, \BTheta) = \evalbar{f(\Bp, \BTheta)}{0} + \evalbar{\Delta f}{0} \Bz + \cdots
\end{align}

First, lets do the potential gradient.

\begin{align}\label{eqn:hamiltonian:voo30}
\Delta (\grad \phi) = 
\begin{bmatrix}
0 &
{ \begin{bmatrix}
\frac{\partial^2 \phi}{ \partial \theta_r \partial \theta_c }
\end{bmatrix} }_{r,c}
\end{bmatrix}
\end{align}

Next in terms of complexity is the first order term of $\dot{\BTheta}$, for which we have

\begin{align*}
\Delta (\mathcal{I}^{-1} \Bp)
&=
\begin{bmatrix}
{
\begin{bmatrix}
\mathcal{I}^{-1} 
{\begin{bmatrix}
\delta_{rc}
\end{bmatrix}}_{r}
\end{bmatrix}}_{c}
&
{\begin{bmatrix}
\PD{\theta_c}{(\mathcal{I}^{-1})} \Bp \\
\end{bmatrix}}_{c}
\end{bmatrix} \\
\end{align*}

The $\delta$ over all rows $r$ and columns $c$ is the identity matrix and we are left with

\begin{align}\label{eqn:hamiltonian:voo30b}
\Delta (\mathcal{I}^{-1} \Bp)
&=
\begin{bmatrix}
\mathcal{I}^{-1} 
&
{\begin{bmatrix}
\PD{\theta_c}{(\mathcal{I}^{-1})} \Bp \\
\end{bmatrix}}_{c}
\end{bmatrix} 
\end{align}

Next, consider just the $P_\theta$ dependence in the elements of the row vector

\begin{align}\label{eqn:hamiltonian:voo30c}
{\begin{bmatrix}
\inv{2} \Bp^\T \mathcal{I}^{-1} \left(\PD{\theta_r}{Q}\right)^\T \mathcal{I}^{-1} \Bp 
\end{bmatrix}}_r
\end{align}

We can take derivatives of this, and exploiting the fact that these elements are scalars, so they equal their transpose.  Also noting that ${A^{-1}}^\T = {A^\T}^{-1}$, and $\mathcal{I} = \mathcal{I}^\T$, we have

\begin{align*}
\PD{P_{\theta_c}}{}
\left( \inv{2} \Bp^\T \mathcal{I}^{-1} \left(\PD{\theta_r}{Q}\right)^\T \mathcal{I}^{-1} \Bp  \right)
&=
\inv{2} \Bp^\T \mathcal{I}^{-1} \left(\PD{\theta_r}{Q}\right)^\T \mathcal{I}^{-1} 
{\begin{bmatrix}
\delta_{rc}
\end{bmatrix}}_r
+
\inv{2} 
\left({\begin{bmatrix}
\delta_{rc}
\end{bmatrix}}_r \right)^\T
\mathcal{I}^{-1} \left(\PD{\theta_r}{Q}\right)^\T \mathcal{I}^{-1} \Bp 
\\
&=
\Bp^\T \mathcal{I}^{-1} \left( \PD{\theta_r}{}
\inv{2} \left( Q + Q^T \right) \right)
\mathcal{I}^{-1} 
{\begin{bmatrix}
\delta_{rc}
\end{bmatrix}}_r \\
&=
\Bp^\T \mathcal{I}^{-1} \PD{\theta_r}{\mathcal{I}}
\mathcal{I}^{-1} 
{\begin{bmatrix}
\delta_{rc}
\end{bmatrix}}_r \\
\end{align*}

Since we also have $B' B^{-1} + B (B^{-1})' = 0$, for invertible matrixes $B$, this reduces to

\begin{align*}
\PD{P_{\theta_c}}{}
\left( \inv{2} \Bp^\T \mathcal{I}^{-1} \left(\PD{\theta_r}{Q}\right)^\T \mathcal{I}^{-1} \Bp  \right)
&=
-\Bp^\T \PD{\theta_r}{(\mathcal{I}^{-1})}
{\begin{bmatrix}
\delta_{rc}
\end{bmatrix}}_r \\
\end{align*}

Forming the matrix over all rows $r$, and columns $c$, we get a trailing identity multiplying from the right, and are left with

\begin{align}\label{eqn:hamiltonian:voo31}
{\begin{bmatrix}
\PD{P_{\theta_c}}{}
\left( \inv{2} \Bp^\T \mathcal{I}^{-1} \left(\PD{\theta_r}{Q}\right)^\T \mathcal{I}^{-1} \Bp  \right)
\end{bmatrix}}_{r,c} 
&=
{\begin{bmatrix}
-\Bp^\T \PD{\theta_r}{(\mathcal{I}^{-1})}
\end{bmatrix}}_{r} 
=
{\begin{bmatrix}
-\PD{\theta_c}{(\mathcal{I}^{-1})} \Bp
\end{bmatrix}}_{c} 
\end{align}

Okay, getting closer.  The only thing left is to consider the remaining $\theta$ dependence of \eqnref{eqn:hamiltonian:voo30c}, and now want the theta partials of the scalar matrix elements

\begin{align*}
\PD{\theta_c}{}&
\left( \inv{2} \Bp^\T \mathcal{I}^{-1} \left(\PD{\theta_r}{Q}\right)^\T \mathcal{I}^{-1} \Bp  \right) \\
&=
\Bp^\T 
\left( 
\PD{\theta_c}{}
\left( 
\inv{2} \mathcal{I}^{-1} \left(\PD{\theta_r}{Q}\right)^\T \mathcal{I}^{-1} 
\right)
\right)
\Bp  \\
&=
\Bp^\T 
\inv{2} \mathcal{I}^{-1} \frac{\partial^2 Q^\T}{\partial \theta_c \partial \theta_r} \mathcal{I}^{-1} 
\Bp 
+
\Bp^\T 
\inv{2} \left( 
\PD{\theta_c}{(\mathcal{I}^{-1})} \left(\PD{\theta_r}{Q}\right)^\T \mathcal{I}^{-1} 
+\mathcal{I}^{-1} \left(\PD{\theta_r}{Q}\right)^\T \PD{\theta_c}{(\mathcal{I}^{-1} )}
\right)
\Bp \\
&=
\Bp^\T 
\inv{2} \mathcal{I}^{-1} \frac{\partial^2 Q^\T}{\partial \theta_c \partial \theta_r} \mathcal{I}^{-1} 
\Bp 
+
\Bp^\T 
\PD{\theta_c}{(\mathcal{I}^{-1})} \PD{\theta_r}{\mathcal{I}} \mathcal{I}^{-1} 
\Bp \\
\end{align*}

There is a slight asymmetry between the first and last terms here that can possibly be eliminated.  Using ${B^{-1}}' = -B^{-1} B' B^{-1}$, we can factor out the $\mathcal{I}^{-1}\Bp = \dot{\BTheta}$ terms
% I' = - I {I^{-1}}' I 

\begin{align*}
\PD{\theta_c}{}
\left( \inv{2} \Bp^\T \mathcal{I}^{-1} \left(\PD{\theta_r}{Q}\right)^\T \mathcal{I}^{-1} \Bp  \right) 
&=
\dot{\BTheta}^\T 
\left(
\inv{2} \frac{\partial^2 Q^\T}{\partial \theta_c \partial \theta_r} 
-
\PD{\theta_c}{\mathcal{I}} 
\mathcal{I}^{-1}
\PD{\theta_r}{\mathcal{I}} 
\right)
\dot{\BTheta}
\end{align*}

Is this any better?  Maybe a bit.  Since we are forming the matrix over all $r,c$ indices and can assume mixed partial commutation the transpose can be dropped leaving us with

\begin{align}\label{eqn:hamiltonian:voo32}
{\begin{bmatrix}
\PD{\theta_c}{}
\left( \inv{2} \Bp^\T \mathcal{I}^{-1} \left(\PD{\theta_r}{Q}\right)^\T \mathcal{I}^{-1} \Bp  \right) 
\end{bmatrix}}_{r,c} 
&=
{\begin{bmatrix}
\dot{\BTheta}^\T 
\left(
\inv{2} \frac{\partial^2 Q}{\partial \theta_c \partial \theta_r} 
-
\PD{\theta_c}{\mathcal{I}} 
\mathcal{I}^{-1}
\PD{\theta_r}{\mathcal{I}} 
\right)
\dot{\BTheta}
\end{bmatrix}}_{r,c} 
\end{align}

We can now assemble all these individual derivatives

\begin{align}\label{eqn:hamiltonian:voo29a}
\dot{\Bz} 
&\approx
\evalnobar{
\begin{bmatrix}
{\begin{bmatrix}
\inv{2} \dot{\BTheta} \left(\PD{\theta_r}{Q}\right)^\T \dot{\BTheta}
\end{bmatrix}}_r
- \grad \phi \\
\dot{\BTheta}
\end{bmatrix}
}{t=0} 
%\\
%&
+
\evalnobar{
\begin{bmatrix}
-{\begin{bmatrix}
\PD{\theta_c}{(\mathcal{I}^{-1})} \Bp
\end{bmatrix}}_{c} &
{\begin{bmatrix}
\dot{\BTheta}^\T 
\left(
\inv{2} \frac{\partial^2 Q}{\partial \theta_c \partial \theta_r} 
-
\PD{\theta_c}{\mathcal{I}} 
\mathcal{I}^{-1}
\PD{\theta_r}{\mathcal{I}} 
\right)
\dot{\BTheta}
-\frac{\partial^2 \phi}{ \partial \theta_r \partial \theta_c }
\end{bmatrix}}_{r,c} \\
\\
\mathcal{I}^{-1} 
&
{\begin{bmatrix}
\PD{\theta_c}{(\mathcal{I}^{-1})} \Bp \\
\end{bmatrix}}_{c}
\end{bmatrix} 
}{t=0} \Bz
\end{align}

We have both $\PDi{\theta_k}{(\mathcal{I}^{-1})}$ and $\PDi{\theta_k}{\mathcal{I}}$ derivatives above, which will complicate things when trying to evaluate this for any specific system.  A final elimination of the derivatives of the inverse inertial matrix leaves us with

\begin{align}\label{eqn:hamiltonian:voo29b}
\dot{\Bz} 
&\approx
\evalnobar{
\begin{bmatrix}
{\begin{bmatrix}
\inv{2} \dot{\BTheta} \left(\PD{\theta_r}{Q}\right)^\T \dot{\BTheta}
\end{bmatrix}}_r
- \grad \phi \\
\dot{\BTheta}
\end{bmatrix}
}{t=0} 
+
\evalnobar{
\begin{bmatrix}
{\begin{bmatrix}
\mathcal{I}^{-1} \PD{\theta_c}{\mathcal{I}} \dot{\BTheta}
\end{bmatrix}}_{c} &
{\begin{bmatrix}
\dot{\BTheta}^\T 
\left(
\inv{2} \frac{\partial^2 Q}{\partial \theta_c \partial \theta_r} 
-
\PD{\theta_c}{\mathcal{I}} 
\mathcal{I}^{-1}
\PD{\theta_r}{\mathcal{I}} 
\right)
\dot{\BTheta}
-\frac{\partial^2 \phi}{ \partial \theta_r \partial \theta_c }
\end{bmatrix}}_{r,c} \\
\\
\mathcal{I}^{-1} 
&
-
{\begin{bmatrix}
\mathcal{I}^{-1} \PD{\theta_c}{\mathcal{I}} \dot{\BTheta}
\end{bmatrix}}_{c}
\end{bmatrix} 
}{t=0} \Bz
\end{align}

\subsubsection{Single pendulum verification}

Having accumulated this unholy mess of abstraction, lets verify this first against the previous result obtained for the single planar pendulum.  Then if that checks out, calculate these matrices explicitly for the double and multiple pendulum cases.  For the single mass pendulum we have

\begin{align}\label{eqn:hamiltonian:voo40}
Q &= \mathcal{I} = m l^2 \\
\phi &= - m g l \cos\theta
\end{align}

So all the $\theta$ partials except that of the potential are zero.  For the potential we have

\begin{align}\label{eqn:hamiltonian:voo41}
\evalbar{- \frac{\partial^2 \phi}{\partial^2 \theta}}{0} = - m g l \cos\theta_0
\end{align}

and for the angular gradient 

\begin{align}\label{eqn:hamiltonian:voo42}
\evalbar{-\grad \phi}{0} = 
\begin{bmatrix} 
- m g l \sin\theta_0
\end{bmatrix} 
\end{align}

Putting these all together in this simplest application of \eqnref{eqn:hamiltonian:voo29b} we have for the linear approximation of a single point mass pendulum about some point in phase space at time zero:

\begin{align}\label{eqn:hamiltonian:voo43}
\dot{\Bz} \approx 
\begin{bmatrix} 
- m g l \sin\theta_0 \\
\dot{\theta}_0
\end{bmatrix} 
+\begin{bmatrix} 
0 & - m g l \cos\theta_0 \\
\inv{m l^2} & 0
\end{bmatrix} \Bz
\end{align}

Excellent.  Have not gotten into too much trouble with the math so far.  This is consistent with the previous results obtained considering the simple pendulum directly (it actually pointed out an error in the earlier pendulum treatment which is now fixed (I had dropped the $\dot{\theta}_0$ term)).

\subsubsection{Double pendulum explicitly}

For the double pendulum, with $\delta = \theta_1 - \theta_2$, and $M = m_1 + m_2$, we have

\begin{align}\label{eqn:hamiltonian:xoo1}
Q = 
\begin{bmatrix}
M {l_1}^2 & m_2 l_2 l_1 e^{i(\theta_2 - \theta_1)} \\
m_2 l_1 l_2 e^{i(\theta_1 - \theta_2)} & m_2 {l_2}^2 \\
\end{bmatrix}
=
\begin{bmatrix}
M {l_1}^2 & m_2 l_2 l_1 e^{-i\delta} \\
m_2 l_1 l_2 e^{i\delta} & m_2 {l_2}^2 \\
\end{bmatrix}
\end{align}

\begin{align*}
\inv{2} \dot{\BTheta}^\T \left(\PD{\theta_1}{Q} \right)^\T \dot{\BTheta}
&= 
\inv{2} m_2 l_1 l_2 i
\dot{\BTheta}^\T 
{\begin{bmatrix}
0 & - e^{-i\delta} \\
e^{i\delta} & 0
\end{bmatrix}}^\T
\dot{\BTheta} \\
&= 
\inv{2} m_2 l_1 l_2 i
\dot{\BTheta}^\T 
\begin{bmatrix}
e^{i\delta} \dot{\theta}_2 \\
-e^{-i\delta} \dot{\theta}_1 
\end{bmatrix} \\
&= 
\inv{2} m_2 l_1 l_2 i \dot{\theta}_1 \dot{\theta}_2 (e^{i\delta} -e^{-i\delta}) \\
&= 
-m_2 l_1 l_2 \dot{\theta}_1 \dot{\theta}_2 \sin\delta
\end{align*}

The $\theta_2$ derivative is the same but inverted in sign, so we have most of the constant term calculated.  We need the potential gradient to complete.  Our potential was

\begin{align}\label{eqn:hamiltonian:xoo2}
\phi = - M l_1 g \cos{\theta_1} - m_2 l_2 g \cos{\theta_2}
\end{align}

So, the gradient is

\begin{align}\label{eqn:hamiltonian:xoo3}
\grad \phi =
\begin{bmatrix}
M l_1 g \sin{\theta_1} \\
m_2 l_2 g \sin{\theta_2}
\end{bmatrix}
\end{align}

Putting things back together we have for the linear approximation of the two pendulum system

\begin{align}\label{eqn:hamiltonian:xoo4}
\dot{\Bz} = 
\evalnobar{
\begin{bmatrix}
m_2 l_1 l_2 \dot{\theta}_1 \dot{\theta}_2 \sin(\theta_1 - \theta_2) 
\begin{bmatrix}
-1 \\
1
\end{bmatrix}
& - g
\begin{bmatrix}
M l_1 \sin{\theta_1} \\
m_2 l_2 \sin{\theta_2} \\
\end{bmatrix} 
\\
\dot{\theta}_1 \\
\dot{\theta}_2 \\
\end{bmatrix}}{t=0}
+ A \Bz
\end{align}

Where $A$ is still to be determined (from \eqnref{eqn:hamiltonian:voo29b}).

One of the elements of $A$ are the matrix of potential derivatives.  These are

\begin{align}\label{eqn:hamiltonian:potentialDerivatives}
\begin{bmatrix}
\PD{\theta_1}{\grad \phi} & \PD{\theta_2}{\grad \phi}
\end{bmatrix}
=
\begin{bmatrix}
M l_1 g \cos\theta_1 & 0 \\
0 & m_2 l_2 g \cos\theta_2
\end{bmatrix}
\end{align}

We also need the inertial matrix and its inverse.  These are

\begin{align}\label{eqn:hamiltonian:xoo6}
\mathcal{I}
=
\begin{bmatrix}
M {l_1}^2 & m_2 l_2 l_1 \cos\delta \\
m_2 l_1 l_2 \cos\delta & m_2 {l_2}^2 \\
\end{bmatrix}
\end{align}

\begin{align}\label{eqn:hamiltonian:Iinverse}
\mathcal{I}^{-1}
=
\inv{{l_1}^2 {l_2}^2 m_2 (M - m_2 \cos^2\delta)}
\begin{bmatrix}
m_2 {l_2}^2 & -m_2 l_2 l_1 \cos\delta \\
-m_2 l_1 l_2 \cos\delta & M {l_1}^2 \\
\end{bmatrix}
\end{align}

Since 

\begin{align}\label{eqn:hamiltonian:xoo8}
\PD{\theta_1}{Q} 
&= 
m_2 l_1 l_2 i
\begin{bmatrix}
0 & - e^{-i\delta} \\
e^{i\delta} & 0
\end{bmatrix} 
\end{align}

We have
\begin{align}\label{eqn:hamiltonian:xoo9}
\PD{\theta_1}{} \PD{\theta_1}{Q} &=
-m_2 l_1 l_2 
\begin{bmatrix}
0 & e^{-i\delta} \\
e^{i\delta} & 0
\end{bmatrix} \\
\PD{\theta_2}{} \PD{\theta_1}{Q} &=
m_2 l_1 l_2 
\begin{bmatrix}
0 & e^{-i\delta} \\
e^{i\delta} & 0
\end{bmatrix} \\
\PD{\theta_1}{} \PD{\theta_2}{Q} &=
m_2 l_1 l_2 
\begin{bmatrix}
0 & e^{-i\delta} \\
e^{i\delta} & 0
\end{bmatrix}  \\
\PD{\theta_2}{} \PD{\theta_2}{Q} &=
-m_2 l_1 l_2 
\begin{bmatrix}
0 & e^{-i\delta} \\
e^{i\delta} & 0
\end{bmatrix} 
\end{align}

and the matrix of derivatives becomes

\begin{align}\label{eqn:hamiltonian:matrixOfSecondPartials}
\inv{2}\dot{\BTheta}^\T \PD{\theta_c}{}\PD{\theta_r}{Q} \dot{\BTheta}
=
m_2 l_1 l_2 
\dot{\theta_1} 
\dot{\theta_2} \cos(\theta_1 - \theta_2)
\begin{bmatrix}
-1 & 1 \\
1 & -1
\end{bmatrix} 
\end{align}

For the remaining two types of terms in the matrix $A$ we need $\mathcal{I}^{-1} \PDi{\theta_k}{\mathcal{I}}$.   The derivative of the inertial matrix is

\begin{align}\label{eqn:hamiltonian:xoo11}
\PD{\theta_k}{\mathcal{I}}
=
-m_2 l_1 l_2 (\delta_{k1} - \delta_{k2})
\begin{bmatrix}
0 & \sin\delta \\
\sin\delta & 0
\end{bmatrix}
\end{align}

Computing the product
\begin{align*}
\mathcal{I}^{-1} \PD{\theta_k}{\mathcal{I}}
&=
\frac{ -m_2 l_1 l_2 (\delta_{k1} - \delta_{k2}) }{{l_1}^2 {l_2}^2 m_2 (M - m_2 \cos^2\delta)}
\begin{bmatrix}
m_2 {l_2}^2 & -m_2 l_2 l_1 \cos\delta \\
-m_2 l_1 l_2 \cos\delta & M {l_1}^2 \\
\end{bmatrix}
\begin{bmatrix}
0 & \sin\delta \\
\sin\delta & 0
\end{bmatrix} \\
&=
\frac{ -m_2 l_1 l_2 (\delta_{k1} - \delta_{k2}) \sin\delta}{{l_1}^2 {l_2}^2 m_2 (M - m_2 \cos^2\delta)}
\begin{bmatrix}
-m_2 l_2 l_1 \cos\delta & m_2 {l_2}^2 \\
M {l_1}^2 & -m_2 l_1 l_2 \cos\delta \\
\end{bmatrix}
\end{align*}

We want the matrix of $\mathcal{I}^{-1} \PDi{\theta_c}{\mathcal{I}} \dot{\BTheta}$ over columns $c$, and this is

\begin{align}\label{eqn:hamiltonian:veryMessy}
{\begin{bmatrix}
\mathcal{I}^{-1} \PDi{\theta_c}{\mathcal{I}} \dot{\BTheta}
\end{bmatrix}}_{c}
=
\frac{ m_2 l_1 l_2 \sin\delta}{{l_1}^2 {l_2}^2 m_2 (M - m_2 \cos^2\delta)}
\begin{bmatrix}
m_2 l_2 l_1 \cos\delta \dot{\theta}_1 - m_2 {l_2}^2 \dot{\theta}_2 & -m_2 l_2 l_1 \cos\delta \dot{\theta}_1 + m_2 {l_2}^2 \dot{\theta}_2 \\
-M {l_1}^2 \dot{\theta}_1 +m_2 l_1 l_2 \cos\delta \dot{\theta}_2 & M {l_1}^2 \dot{\theta}_1 -m_2 l_1 l_2 \cos\delta \dot{\theta}_2
\end{bmatrix}
\end{align}

Very messy.  Perhaps it would be better not even bothering to expand this explicitly?  The last term in the matrix $A$ is probably no better.  For that we want

\begin{align*}
-\PD{\theta_c}{\mathcal{I}} \mathcal{I}^{-1} \PD{\theta_r}{\mathcal{I}}
&=
\frac{ -{m_2}^2 {l_1}^2 {l_2}^2 
(\delta_{c1} - \delta_{c2}) (\delta_{r1} - \delta_{r2}) \sin^2\delta}{{l_1}^2 {l_2}^2 m_2 (M - m_2 \cos^2\delta)}
\begin{bmatrix}
0 & 1 \\
1 & 0
\end{bmatrix}
\begin{bmatrix}
-m_2 l_2 l_1 \cos\delta & m_2 {l_2}^2 \\
M {l_1}^2 & -m_2 l_1 l_2 \cos\delta \\
\end{bmatrix} \\
&=
\frac{ -{m_2}^2 {l_1}^2 {l_2}^2 
(\delta_{c1} - \delta_{c2}) (\delta_{r1} - \delta_{r2}) \sin^2\delta}{{l_1}^2 {l_2}^2 m_2 (M - m_2 \cos^2\delta)}
\begin{bmatrix}
M {l_1}^2 & -m_2 l_1 l_2 \cos\delta \\
-m_2 l_2 l_1 \cos\delta & m_2 {l_2}^2 \\
\end{bmatrix} \\
\end{align*}

With a sandwich of this between $\dot{\BTheta}^\T$ and $\dot{\BTheta}$ we are almost there

\begin{align*}
-
\dot{\BTheta}^\T
\PD{\theta_c}{\mathcal{I}} \mathcal{I}^{-1} \PD{\theta_r}{\mathcal{I}}
\dot{\BTheta}
&=
\frac{ -{m_2}^2 {l_1}^2 {l_2}^2 
(\delta_{c1} - \delta_{c2}) (\delta_{r1} - \delta_{r2}) \sin^2\delta}{{l_1}^2 {l_2}^2 m_2 (M - m_2 \cos^2\delta)}
\left( M {l_1}^2 {\dot{\theta}_1}^2 
-
2
m_2 l_1 l_2 \cos\delta \dot{\theta_1} \dot{\theta}_2 +
%-m_2 l_2 l_1 \cos\delta \dot{\theta}_1 \dot{\theta}_2 
+ m_2 {l_2}^2 {\dot{\theta}_2}^2 \right)
\end{align*}

we have a matrix of these scalars over $r,c$, and that is

\begin{align}\label{eqn:hamiltonian:quadraticPartials}
{\begin{bmatrix}
-
\dot{\BTheta}^\T
\PD{\theta_c}{\mathcal{I}} \mathcal{I}^{-1} \PD{\theta_r}{\mathcal{I}}
\dot{\BTheta}
\end{bmatrix}}_{rc}
&=
\frac{ {m_2}^2 {l_1}^2 {l_2}^2 
\sin^2\delta}{{l_1}^2 {l_2}^2 m_2 (M - m_2 \cos^2\delta)}
\left(
M {l_1}^2 {\dot{\theta}_1}^2 - 2 m_2 l_1 l_2 \cos\delta \dot{\theta_1} \dot{\theta}_2 
+ m_2 {l_2}^2 {\dot{\theta}_2}^2  \right)
\begin{bmatrix}
-1 &  1 \\
 1 & -1
\end{bmatrix} 
%(\delta_{c1} - \delta_{c2}) (\delta_{r1} - \delta_{r2})
\end{align}

Putting all the results for the matrix $A$ together is going to make a disgusting mess, so lets summarize in block matrix form

\begin{align*}%\label{eqn:hamiltonian:xoo12}
A &= 
\evalnobar{\begin{bmatrix}
B & C \\
\mathcal{I}^{-1} & -B
\end{bmatrix}}{t=0} \\
B &=
%{eqn:hamiltonian:veryMessy}
\frac{ m_2 l_1 l_2 \sin\delta}{{l_1}^2 {l_2}^2 m_2 (M - m_2 \cos^2\delta)}
\begin{bmatrix}
m_2 l_2 l_1 \cos\delta \dot{\theta}_1 - m_2 {l_2}^2 \dot{\theta}_2 & -m_2 l_2 l_1 \cos\delta \dot{\theta}_1 + m_2 {l_2}^2 \dot{\theta}_2 \\
-M {l_1}^2 \dot{\theta}_1 +m_2 l_1 l_2 \cos\delta \dot{\theta}_2 & M {l_1}^2 \dot{\theta}_1 -m_2 l_1 l_2 \cos\delta \dot{\theta}_2
\end{bmatrix} \\
C &=
\left(
% {eqn:hamiltonian:matrixOfSecondPartials}
m_2 l_1 l_2 
\dot{\theta_1} 
\dot{\theta_2} \cos \delta
+
% {eqn:hamiltonian:quadraticPartials}
\frac{ {m_2}^2 {l_1}^2 {l_2}^2 
\sin^2\delta}{{l_1}^2 {l_2}^2 m_2 (M - m_2 \cos^2\delta)}
\left(
M {l_1}^2 {\dot{\theta}_1}^2 - 2 m_2 l_1 l_2 \cos\delta \dot{\theta_1} \dot{\theta}_2 
+ m_2 {l_2}^2 {\dot{\theta}_2}^2  \right)
\right)
\begin{bmatrix}
-1 & 1 \\
1 & -1
\end{bmatrix} \\
&\qquad+
% {eqn:hamiltonian:potentialDerivatives}
\begin{bmatrix}
M l_1 g \cos\theta_1 & 0 \\
0 & m_2 l_2 g \cos\theta_2
\end{bmatrix} \\
%{eqn:hamiltonian:Iinverse}
\mathcal{I}^{-1}
&=
\inv{{l_1}^2 {l_2}^2 m_2 (M - m_2 \cos^2\delta)}
\begin{bmatrix}
m_2 {l_2}^2 & -m_2 l_2 l_1 \cos\delta \\
-m_2 l_1 l_2 \cos\delta & M {l_1}^2 \\
\end{bmatrix} \\
%{eqn:hamiltonian:xoo4}
b &=
\begin{bmatrix}
m_2 l_1 l_2 \dot{\theta}_1 \dot{\theta}_2 \sin(\theta_1 - \theta_2) 
\begin{bmatrix}
-1 \\
1
\end{bmatrix}
& - g
\begin{bmatrix}
M l_1 \sin{\theta_1} \\
m_2 l_2 \sin{\theta_2} \\
\end{bmatrix} 
\\
\dot{\theta}_1 \\
\dot{\theta}_2 \\
\end{bmatrix}
\end{align*}

where these are all related by the first order matrix equation

\begin{align}\label{eqn:hamiltonian:xoo20}
\frac{d\Bz}{dt} &= \evalbar{\Bb}{t=0} + \evalbar{A}{t=0} \Bz
\end{align}

Wow, even to just write down the equations required to get a linear approximation of the two pendulum system is horrendously messy, and this is not even trying to solve it.  Numerical and or symbolic computation is really called for here.  If one elected to do this numerically, which looks pretty much mandatory since the analytic way did not turn out to be simple even for just the two pendulum system, then one is probably better off going all the way back to \eqnref{eqn:hamiltonian:veryGeneral} and just calculating the increment for the trajectory using a very small time increment, and do this repeatedly (i.e. do a zeroth order numerical procedure instead of the first order which turns out much more complicated).

\subsection{Dangling mass connected by string to another}

TODO.

% not sure what I wanted to do for these two.  Do not quite fit with the rest being so specific.
%\subsection{Particle in non-velocity dependent potential}
%
%TODO.
%
%\subsection{Velocity dependent potential}
%
%TODO.

\subsection{Non-covariant Lorentz force}

In \citep{jackson1975cew}, the Lagrangian for a charged particle is given as (12.9) as 

\begin{align}\label{eqn:hamiltonian:em1}
\LL = -m c^2 \sqrt{1 - \Bu^2/c^2} + \frac{e}{c} \Bu \cdot \BA - e \Phi.
\end{align}

Let us work in detail from this to the Lorentz force law and the Hamiltonian and from the Hamiltonian again to the Lorentz force law using the Hamiltonian equations.  We should get the same results in each case, and have enough details in doing so to render the text a bit more comprehensible.

\subsubsection{Canonical momenta}

We need the conjugate momenta for both the Euler-Lagrange evaluation and the Hamiltonian, so lets get that first.  The components of this are

\begin{align*}
\PD{\dot{x}_i}{\LL} 
&= - \inv{2} m c^2 \gamma (-2/c^2) \dot{x}_i + \frac{e}{c} A_i \\
&= m \gamma \dot{x}_i + \frac{e}{c} A_i.
\end{align*}

In vector form the canonical momenta are then

\begin{align}\label{eqn:hamiltonian:em2}
\BP &= \gamma m \Bu + \frac{e}{c} \BA.
\end{align}

\subsubsection{Euler-Lagrange evaluation}

Completing the Euler-Lagrange equation evaluation is the calculation of

\begin{align}\label{eqn:hamiltonian:em2b}
\frac{d\BP}{dt} = \spacegrad \LL.
\end{align}

On the left hand side we have

\begin{align}\label{eqn:hamiltonian:em2l}
\frac{d\BP}{dt} = \frac{d(\gamma m \Bu)}{dt} + \frac{e}{c} \frac{d\BA }{dt},
\end{align}

and on the right, with implied summation over repeated indices, we have

\begin{align}\label{eqn:hamiltonian:em2r}
\spacegrad \LL = \frac{e}{c} \Be_k (\Bu \cdot \partial_k \BA) - e \spacegrad \Phi.
\end{align}

Putting things together we have

\begin{align*}
\frac{d(\gamma m \Bu)}{dt} 
&= 
-e \left(
\spacegrad \Phi + \inv{c} \PD{t}{\BA}
+ \frac{1}{c} 
\left(
\PD{x_a}{\BA} \PD{t}{x_a} - \Be_k (\Bu \cdot \partial_k \BA) 
\right)
\right) \\
&= 
-e \left(
\spacegrad \Phi + \inv{c} \PD{t}{\BA}
+ \frac{1}{c} \Be_b u_a
\left(
\PD{x_a}{A_b} 
-
\PD{x_b}{A_a}
\right)
\right).
\end{align*}

With 

\begin{align}\label{eqn:hamiltonian:em3}
\BE = -\spacegrad \Phi - \inv{c} \PD{t}{\BA},
\end{align}

the first two terms are recognizable as the electric field.  To put some structure in the remainder start by writing

\begin{align}\label{eqn:hamiltonian:em4}
\PD{x_a}{A_b} - \PD{x_b}{A_a} = \epsilon^{fab} {(\spacegrad \cross \BA)}_f.
\end{align}

The remaining term, with $\BB = \spacegrad \cross \BA$ is now 
 
\begin{align*}
- \frac{e}{c} \Be_b u_a \epsilon^{gab} B_g
&=
\frac{e}{c} 
\Be_a u_b \epsilon^{abg} B_g \\
&= 
\frac{e}{c} \Bu \cross \BB.
\end{align*}

We are left with the momentum portion of the Lorentz force law as expected

\begin{align}\label{eqn:hamiltonian:em5}
\frac{d(\gamma m \Bu)}{dt} = e \left( \BE + \frac{1}{c} \Bu \cross \BB \right).
\end{align}

Observe that with a small velocity Taylor expansion of the Lagrangian we obtain the approximation

\begin{align}\label{eqn:hamiltonian:em6}
-m c^2 \sqrt{ 1 -\Bu^2/c^2} \approx - m c^2 \left( 1 - \inv{2} \Bu^2/c^2 \right) = \inv{2} m \Bu^2
\end{align}

If that is our starting place, we can only obtain the non-relativistic approximation of the momentum change by evaluating the Euler-Lagrange equations

\begin{align}\label{eqn:hamiltonian:em5a}
\frac{d (m \Bu)}{dt} = e \left( \BE + \frac{1}{c} \Bu \cross \BB \right).
\end{align}

That was an exercise previously attempting working the Tong Lagrangian problem set \citep{TongMf1}.

\subsubsection{Hamiltonian}

Having confirmed the by old fashioned Euler-Lagrange equation evaluation that our Lagrangian provides the desired equations of motion, let us now try it using the Hamiltonian approach.  First we need the Hamiltonian, which is nothing more than

\begin{align}\label{eqn:hamiltonian:em10}
H = \BP \cdot \Bu - \LL
\end{align}

However, in the Lagrangian and the dot product we have velocity terms that we must eliminate in favor of the canonical momenta.  The Hamiltonian remains valid in either form, but to apply the Hamiltonian equations we need $H = H(\BP, \Bx)$, and not $H = H(\Bu, \BP, \Bx)$.

\begin{align}\label{eqn:hamiltonian:em11}
H = \BP \cdot \Bu + m c^2 \sqrt{1 - \Bu^2/c^2} - \frac{e}{c} \Bu \cdot \BA + e \Phi.
\end{align}

Or
\begin{align}\label{eqn:hamiltonian:em11b}
H = \Bu \cdot \left(\BP - \frac{e}{c} \BA\right) + m c^2 \sqrt{1 - \Bu^2/c^2} + e \Phi.
\end{align}

We can rearrange \eqnref{eqn:hamiltonian:em2} for $\Bu$

\begin{align}\label{eqn:hamiltonian:em12}
\Bu = \inv{m \gamma} \left( \BP - \frac{e}{c} \BA \right),
\end{align}

but $\gamma$ also has a $\Bu$ dependence, so this is not complete.  Squaring gets us closer

\begin{align}\label{eqn:hamiltonian:em13}
\Bu^2 = \frac{1 - \Bu^2/c^2}{m^2} {\left( \BP - \frac{e}{c} \BA \right)}^2,
\end{align}

and a bit of final rearrangement yields

\begin{align}\label{eqn:hamiltonian:em14}
\Bu^2 = \frac{(c \BP - e \BA)^2}{m^2 c^2 + {\left( \BP - \frac{e}{c} \BA \right)}^2}.
\end{align}

Writing $\Bp = \BP - e \BA/c$, we can rearrange and find

\begin{align}\label{eqn:hamiltonian:em14a}
\sqrt{1 - \Bu^2/c^2} = \frac{m c }{\sqrt{m^2 c^2 +\Bp^2}}
\end{align}

Also, taking roots of \eqnref{eqn:hamiltonian:em14} we must have the directions of $\Bu$ and $\left( \BP - \frac{e}{c} \BA \right)$ differ only by a rotation.  From \eqnref{eqn:hamiltonian:em12} we also know that these are colinear, and therefore have

\begin{align}\label{eqn:hamiltonian:em15}
\Bu = \frac{c \BP - e \BA}{\sqrt{m^2 c^2 + {\left( \BP - \frac{e}{c} \BA \right)}^2}}.
\end{align}

This and \eqnref{eqn:hamiltonian:em14a} can now be substituted into \eqnref{eqn:hamiltonian:em11b}, for

\begin{align}\label{eqn:hamiltonian:em11c}
H = \frac{c}{m^2 c^2 + \Bp^2} 
\left(
{\left(\BP - \frac{e}{c} \BA\right)}^2 + m^2 c^2 
\right)
+ e \Phi.
\end{align}

Dividing out the common factors we finally have the Hamiltonian in a tidy form

\begin{align}\label{eqn:hamiltonian:em20}
H = \sqrt{ (c \BP - e \BA)^2 + m^2 c^4 } + e\Phi.
\end{align}

\subsubsection{Hamiltonian equation evaluation}

Let us now go through the exercise of evaluating the Hamiltonian equations.  We want the starting point to be just the energy expression \eqnref{eqn:hamiltonian:em20}, and the use of the Hamiltonian equations and none of what led up to that.  If we were given only this Hamiltonian and the Hamiltonian principle

\begin{subequations}
\begin{align}\label{eqn:hamiltonian:em21}
\PD{P_k}{H} &= u_k \\
\PD{x_k}{H} &= -\dot{P}_k,
\end{align}
\end{subequations}

how far can we go?

For the particle velocity we have no $\Phi$ dependence and get

\begin{align}\label{eqn:hamiltonian:em22}
u_k &= \frac{c (c P_k -e A_k)}{\sqrt{ (c \BP - e \BA)^2 + m^2 c^4 }}
\end{align}

This is \eqnref{eqn:hamiltonian:em15} in coordinate form, one of our stepping stones on the way to the Hamiltonian, and we recover it quickly with our first set of derivatives.  We have the gradient part $\dot{\BP} = -\spacegrad H$ of the Hamiltonian left to evaluate 

\begin{align}\label{eqn:hamiltonian:em23}
\frac{d\BP}{dt} = 
\frac{e (c P_k -e A_k) \spacegrad A_k }{\sqrt{ (c \BP - e \BA)^2 + m^2 c^4 }} - e \spacegrad \Phi.
\end{align}

Or
\begin{align}\label{eqn:hamiltonian:em23b}
\frac{d\BP}{dt} = e \left( \frac{u_k}{c} \spacegrad A_k - \spacegrad \Phi \right)
\end{align}

This looks nothing like the Lorentz force law.  Knowing that $\BP - e\BA/c$ is of significance (because we know where we started which is kind of a cheat), we can subtract derivatives of this from both sides, and use the convective derivative operator $d/dt = \PDi{t}{} + \Bu \cdot \spacegrad$ (ie. chain rule) yielding

\begin{align}\label{eqn:hamiltonian:em23c}
\frac{d}{dt}(\BP - e\BA/c) = e \left( -\inv{c}\PD{t}{\BA} - \inv{c} (\Bu \cdot \spacegrad) \BA + \frac{u_k}{c} \spacegrad A_k - \spacegrad \Phi \right).
\end{align}

The first and last terms sum to the electric field, and we seen evaluating the Euler-Lagrange equations that the remainder is $u_k \spacegrad A_k - (\Bu \cdot \spacegrad) \BA = \Bu \cross (\spacegrad \cross \BA)$.  We have therefore gotten close to the familiar Lorentz force law, and have

\begin{align}\label{eqn:hamiltonian:em24}
\frac{d}{dt}(\BP - e\BA/c) = e \left( \BE + \frac{\Bu}{c} \cross \BB \right).
\end{align}

The only untidy detail left is that $\BP - e \BA/c$ does not look much like $\gamma m \Bu$, what we recognize as the relativistically corrected momentum.  We ought to have that implied somewhere and \eqnref{eqn:hamiltonian:em22} looks like the place.  That turns out to be the case, and some rearrangement gives us this directly

\begin{align}\label{eqn:hamiltonian:em25}
\BP - \frac{e}{c}\BA = \frac{m \Bu}{\sqrt{1 - \Bu^2/c^2}}
\end{align}

This completes the exercise, and we have now obtained the momentum part of the Lorentz force law.  This is still unsatisfactory from a relativistic context since we do not have momentum and energy on equal footing.  We likely need to utilize a covariant Lagrangian and Hamiltonian formulation to fix up that deficiency.

\subsection{Covariant force free case}

TODO.

\subsection{Covariant Lorentz force}

TODO.
