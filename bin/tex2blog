#! /usr/bin/perl

use strict ;
use warnings ;
use Getopt::Long;

my $filebase ;

GetOptions( 
   'file=s'    => \$filebase,
) ;

my $fh ;
my %equations ;
open $fh, "<$filebase.aux" or die "could not open '$filebase.aux'\n" ;
while (<$fh>)
{
   if ( /^\\newlabel{(.*?)}.*equation\.(.*?)}/ )
   {
      $equations{$1} = $2 ;
   }
}
close $fh ;

open $fh, "<$filebase.tex" or die "could not open '$filebase.aux'\n" ;
while (<$fh>)
{
   chomp ;
   s/\\cite{.*?}//;
   s/^%CITE://;
   s/%.*//;

next if (
/\\begin{document}/ or
/\\end{document}/ or
/\\maketitle{}/ or
/\\tableofcontents/ or
/\\usepackage/ or
/\\newcommand/ or
/\\documentclass/ or
/\\title/ or
/\\email/ or
/\\author/ or
/\\bibliography/ or
0 ) ;

   while ( s/\$(.*?)\$/BBB:$1:EEE/g )
   {
   }
   s/BBB:/\$latex /g;
   s/:EEE/\$/g;

   s/\\label{(eqn:.*?)}/($equations{$1})/g ;
   s/\\ref{(eqn:.*?)}/$equations{$1}/g ;

   s,\\section{(.*)},<h1>$1</h1>,;
   s,\\subsection{(.*)},<h2>$1</h1>,;
   s,\\subsubsection{(.*)},<h3>$1</h1>,;

   s/\\begin{align\**}/\$latex /;
   s/\\end{align\**}/\$/;

   s/\\begin{equation\**}/\$latex /;
   s/\\end{equation\**}/\$/;

   s/\\inv{(.*?)}/\\frac{1}{$1}/g;
   s/\\Abs{(.*?)}/{\left\lvert{$1}\right\rvert}/g;
   s/\\gpgrade{(.*?)}{(.*?)}/{\left\langle{{$1}}\right\rangle}_{$2}/g;
   s/\\gpgradeone{(.*?)}{(.*?)}/{\left\langle{{$1}}\right\rangle}_{1}/g;
   s/\\gpgradetwo{(.*?)}{(.*?)}/{\left\langle{{$1}}\right\rangle}_{2}/g;

   s,\\href{(.*?)}{(.*?)},<a href="$1">$2</a>,g ;
   print "$_\n" ;
}
close $fh ;
