#! /usr/bin/perl

use strict ;
use warnings ;
use Getopt::Long;

my $filebase ;
my $showNumbers = 1 ;

GetOptions( 
   'file=s'    => \$filebase,
   'num!'      => \$showNumbers,
) ;

my $fh ;
my %equations ;
open $fh, "<$filebase.aux" or die "could not open '$filebase.aux'\n" ;
while (<$fh>)
{
   if ( /^\\newlabel{(.*?)}.*equation\.(.*?)}/ )
   {
      $equations{$1} = $2 ;
   }
}
close $fh ;

my $bibString = '' ;
my %refnumbers ;
my $curNum = 1 ;
my $haveBib = 1 ;
open $fh, "<$filebase.bbl" or $haveBib = 0 ;

if ( $haveBib )
{
   while (<$fh>)
   {
      chomp ;

      s,\\begin{thebibliography}.*,<h1>References</h1>, ;

#\bibitem[Joot({\natexlab{a}})]{PJLorentzWave}
      s/\\bibitem.*]{/\\bibitem{/ ;
      if ( s/\\bibitem{(.*?)}// )
      {
         $bibString .= "\n\n" ;
         $refnumbers{$1} = $curNum ;
         $bibString .= "[$curNum] " ;

         $curNum++ ;
      }
      else
      {
         next if (/Available from:/ or
                  /\\providecommand/ or
                  /\\expandafter/ or
                  0 ) ;

         if ( /\\end{thebibliography}/ )
         {
            $bibString .= "\n" ;
            last ;
         }

         s/~/ /g ;
         s,\\em *{(.*?)},<em>$1</em>, ;
         s,\\emph *{(.*?)},<em>$1</em>, ;
         s/\\newblock// ;
         s,\\url{(.*?)},<a href="$1">$1</a>,;
         s/{(.*?)}/$1/g ;

         $bibString .= "$_" ;
      }
   }
   close $fh ;
}

my $curEqn = '' ;
my $curEquationLabel = '' ;
my $inEquation = 0 ;
open $fh, "<$filebase.tex" or die "could not open '$filebase.aux'\n" ;
while (<$fh>)
{
   chomp ;
   s/\\cite{(.*?)}/[$refnumbers{$1}]/g;
   s/%.*//;
   s,\\blogpage{(.*)},<a href="$1">[Click here for a PDF of this post with nicer formatting]</a>,;

next if (
/\\begin{document}/ or
/\\end{document}/ or
/\\maketitle/ or
/\\tableofcontents/ or
/\\usepackage/ or
/\\newcommand/ or
/\\documentclass/ or
/\\title/ or
/\\email/ or
/\\date/ or
/\\author/ or
/\\revisionInfo/ or
/\\input/ or
/\\bibliography/ or
/\\beginArtWithToc/ or
/\\EndArticle/ or
0 ) ;

   while ( s/\$(.*?)\$/BBB:$1:EEE/g )
   {
   }
   s/BBB:/\$latex /g;
   s/:EEE/\$/g;

   s/\\ref{(eqn:.*?)}/$equations{$1}/g ;

   s,\\section{(.*)},<h1>$1</h1>,;
   s,\\subsection{(.*)},<h2>$1</h1>,;
   s,\\subsubsection{(.*)},<h3>$1</h1>,;
   s,\\href{(.*?)}{(.*?)},<a href="$1">$2</a>,g ;

   if ( s/\\begin{align\**}// or s/\\begin{equation\**}// )
   {
      if ( s/\\label{(eqn:.*?)}// and $showNumbers )
      {
         $curEquationLabel = "\\quad\\quad\\quad($equations{$1})" ;
      }
      $curEqn .= $_ ;
      $inEquation = 1 ;
   }
   elsif ( s/\\end{align\**}.*// or s/\\end{equation\**}.*// )
   {
      my $eq = '$latex ' . translate( "$curEqn$_" ) . " $curEquationLabel\$" ;
      $eq =~ s/ *\\\\ *\$/\$/g;
      print "$eq\n" ;
      $curEqn = '' ;
      $inEquation = 0 ;
      $curEquationLabel = '' ;
   }
   elsif ( $inEquation )
   {
      $curEqn .= $_ ;
   }
   else
   {
      s/\\label{(.*?)}//g;

      print translate( $_ ) . "\n" ;
   }
}
close $fh ;

print $bibString ;

sub translate
{
   my $out = "@_" ;

   $out =~ s/\\\\/\\\\ /g;
   $out =~ s/&=/=/g;

   # convert some of my macros:
   $out =~ s/\\inv{(.*?)}/\\frac{1}{$1}/g;
   $out =~ s/\\Abs{(.*?)}/{\\left\\lvert{$1}\\right\\rvert}/g;
   $out =~ s/\\gpgrade{(.*?)}{(.*?)}/{\\left\\langle{{$1}}\\right\\rangle}_{$2}/g;
   $out =~ s/\\gpgradeone{(.*?)}/{\\left\\langle{{$1}}\\right\\rangle}_{1}/g;
   $out =~ s/\\gpgradetwo{(.*?)}/{\\left\\langle{{$1}}\\right\\rangle}_{2}/g;
   $out =~ s/\\kcap/\\hat{\\Bk}/g;
   $out =~ s/\\B(.)/\\mathbf{$1}/g;
   $out =~ s/\\LL/\\mathcal{L}/g;
   $out =~ s/\\FF/\\mathcal{F}/g;
   $out =~ s/\\cross/\\times/g;
   $out =~ s/\\grad/\\nabla/g;
   $out =~ s/\\spacegrad/\\boldsymbol{\\nabla}/g;
   $out =~ s/\\delambertian/\\square/g;
   $out =~ s/\\PD{(.*?)}{(.*?)}/\\frac{\\partial {$2}}{\\partial {$1}}}/g ;

   return $out ;
}
